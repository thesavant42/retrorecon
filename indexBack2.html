<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WABAX - Wayback Archive Explorer</title>
  <link rel="stylesheet" href="/static/wabax.css" />
  <style>
    body { font-family: system-ui,sans-serif; }
    #import-status-block {
      margin: 1em 0;
      padding: 0.7em;
      background: #f9f9f2;
      border: 1.5px solid #e0c600;
      color: #444;
      font-size: 1.05em;
      min-width: 290px;
      display: none;
    }
    #import-progress-bar-container {
      width: 100%;
      background: #eee;
      border-radius: 4px;
      margin-top: 5px;
      height: 18px;
      display: none;
    }
    #import-progress-bar {
      height: 100%;
      width: 0%;
      background: #cfcf22;
      border-radius: 4px;
      transition: width 0.4s;
    }
    #import-progress-numbers {
      font-size: 0.95em;
      margin-top: 2px;
      display: none;
    }
    .search-bar input[type="text"] {
      width: 400px;
      font-size: 1.1em;
      padding: 0.3em;
    }
    .btn-wayback {
      display: inline-block;
      padding: 4px 8px;
      background-color: #f3f3f3;
      border: 1px solid #ccc;
      border-radius: 4px;
      text-decoration: none;
      color: #333;
      font-size: 0.9em;
      margin-right: 0.3em;
      white-space: nowrap;
    }
    .btn-wayback:hover {
      background-color: #e0e0e0;
      border-color: #999;
    }
    .copy-btn, .delete-btn, .shodan-btn, .vt-btn, .postman-btn, .github-btn, .google-btn, .crtsh-btn, .exploder-btn {
      display: inline-block;
      padding: 4px 8px;
      background-color: #f3f3f3;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 0.9em;
      cursor: pointer;
      margin-right: 0.3em;
      white-space: nowrap;
    }
    .exploder-btn {
      border: 1px solid #6b6bff;
      background: #eaf0ff;
      color: #222;
    }
    .copy-btn:hover, .delete-btn:hover, .shodan-btn:hover, .vt-btn:hover, .postman-btn:hover, .github-btn:hover, .google-btn:hover, .crtsh-btn:hover, .exploder-btn:hover {
      background-color: #e0e0e0;
      border-color: #1919dd;
    }
    .controls {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 1em;
      margin-bottom: 1em;
    }
    .url-list {
      list-style: none;
      padding-left: 0;
    }
    .url-list li {
      padding: 0.5em 0;
      border-bottom: 1px solid #ddd;
    }
    .url-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .url-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .dropdown {
      position: relative;
      display: inline-block;
    }
    .dropbtn {
      background-color: #f3f3f3;
      color: #333;
      padding: 4px 8px;
      font-size: 0.9em;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      left: auto;
      min-width: 240px;
      max-width: 90vw;
      background-color: #fff;
      box-shadow: 0px 2px 6px rgba(0,0,0,0.2);
      z-index: 20;
      border: 1px solid #ccc;
      white-space: normal;
      overflow-x: auto;
    }
    .dropdown.show .dropdown-content {
      display: block;
    }
    .dropdown-content a {
      color: #333;
      padding: 8px 12px;
      text-decoration: none;
      display: block;
      font-size: 0.9em;
    }
    .dropdown-content a:hover {
      background-color: #e0e0e0;
    }
    .dropdown-content form {
      padding: 8px 12px;
      margin-bottom: 8px;
    }
    .dropdown-content label {
      font-size: 0.96em;
      margin-right: 0.5em;
    }
    .dropdown-content input[type="text"], .dropdown-content input[type="file"] {
      font-size: 0.96em;
      margin-left: 0.3em;
    }
    .dropdown-content button {
      margin-left: 0.3em;
      font-size: 0.95em;
      border-radius: 3px;
      border: 1px solid #bbb;
      background: #f8f8f8;
      cursor: pointer;
    }
    .dropdown-content button:hover {
      background: #e0e0e0;
    }
    @media (max-width: 500px) {
      .dropdown-content {
        min-width: 70vw;
        max-width: 95vw;
        right: 0;
        left: auto;
      }
    }
    .pagination {
      margin: 1em 0;
      display: flex;
      gap: 0.5em;
      flex-wrap: wrap;
      justify-content: center;
    }
    .pagination a {
      padding: 0.3em 0.6em;
      border: 1px solid #ccc;
      border-radius: 4px;
      text-decoration: none;
      color: #333;
    }
    .pagination a:hover {
      background-color: #eee;
    }
    .pagination strong {
      padding: 0.3em 0.6em;
      border: 1px solid #999;
      border-radius: 4px;
      background: #ddd;
    }
  </style>
</head>
<body>
  <h1>üîé‚è≥üìÅ WABAX: Wayback Archive eXplorer üìÅ‚è≥üîé</h1>

  <!-- Import progress bar/status -->
  <div id="import-status-block">
    <strong>Import status:</strong>
    <span id="import-status-text"></span>
    <div id="import-progress-bar-container">
      <div id="import-progress-bar"></div>
    </div>
    <div id="import-progress-numbers">
      <span id="import-progress-numbers-span"></span>
    </div>
  </div>

  <div class="controls">
    <div class="search-bar">
      <form method="GET" action="/">
        <input type="text" name="q" placeholder="Search..." value="{{ q }}" />
        <button type="submit">Search</button>
      </form>
    </div>
    <div class="dropdown" style="position: relative;">
      <button class="dropbtn" id="main-dropdown-btn">Menu ‚ñæ</button>
      <div class="dropdown-content" id="main-dropdown-content">
        <div>
          <form method="POST" action="/fetch_cdx" style="margin-bottom: 8px;">
            <label>üåê Domain:
              <input type="text" name="domain" placeholder="example.com" required style="width:120px;"/>
            </label>
            <button type="submit">Fetch</button>
          </form>
          <form method="POST" action="/import_json" enctype="multipart/form-data" id="import-form">
            <label>üìÑ NDJSON:
              <input type="file" name="json_file" required />
            </label>
            <button type="submit">Import</button>
          </form>
        </div>
        <hr style="margin:8px 0;">
        <div>
          <form method="POST" action="/tools/webpack-zip">
            <label>üîç Explode .js.map URL:
              <input type="text" name="map_url" placeholder="https://example.com/file.js.map" required style="width:160px;" />
            </label>
            <button type="submit">Explode &amp; Download ZIP</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  {% if urls %}
  <div class="pagination">
    {% if page > 1 %}
      <a href="?page=1&q={{ q }}&tag={{ tag }}">‚èÆ First</a>
      <a href="?page={{ page - 1 }}&q={{ q }}&tag={{ tag }}">‚óÄ Prev</a>
    {% endif %}
    {% set start = page - 3 if page - 3 >= 1 else 1 %}
    {% set end = page + 3 if page + 3 <= total_pages else total_pages %}
    {% for p in range(start, end + 1) %}
      {% if p == page %}
        <strong>{{ p }}</strong>
      {% else %}
        <a href="?page={{ p }}&q={{ q }}&tag={{ tag }}">{{ p }}</a>
      {% endif %}
    {% endfor %}
    {% if page < total_pages %}
      <a href="?page={{ page + 1 }}&q={{ q }}&tag={{ tag }}">Next ‚ñ∂</a>
      <a href="?page={{ total_pages }}&q={{ q }}&tag={{ tag }}">Last ‚è≠</a>
    {% endif %}
  </div>

  <form method="POST" action="/bulk_action">
    <div class="bulk-controls" style="margin-bottom: 1em;">
      <select name="action">
        <option value="add_tag" selected>Add Tag</option>
        <option value="remove_tag">Remove Tag</option>
        <option value="delete">Delete</option>
      </select>
      <input type="text" name="tag" placeholder="Tag" />
      <button type="submit">Apply</button>
      <label>
        <input
          type="checkbox"
          onchange="toggleSelectAllMatching(this)"
        />Select all matching
      </label>
      <input type="hidden" name="q" value="{{ q }}" />
      <input type="hidden" name="tag" value="{{ tag }}" />
      <input type="hidden" name="select_all_matching" value="false" />
    </div>

    <ul class="url-list">
      {% for url in urls %}
      <li>
        <div class="url-info">
          <div class="url-row">
            <input
              type="checkbox"
              name="selected_ids"
              value="{{ url.id }}"
            />
            {% if url.url %}
            <a href="{{ url.url }}" target="_blank"
              ><strong>{{ url.url }}</strong></a
            >
            {% else %}
            <strong style="color: red">‚ö†Ô∏è Invalid URL</strong>
            {% endif %}
          </div>
          {% if url.tags %}<small>[{{ url.tags }}]</small>{% endif %}
          {% if url.url %}
          <div>
            <a
              class="btn-wayback"
              href="https://web.archive.org/web/*/{{ url.url }}"
              target="_blank"
              >‚è≥‚öôÔ∏è ü™©Wayback</a
            >
            <button
              type="button"
              class="copy-btn"
              data-url="{{ url.url }}"
            >
              üìã Copy
            </button>
            <form
              method="POST"
              action="/bulk_action"
              style="display:inline;margin-right:0.3em;"
            >
              <input type="hidden" name="action" value="delete" />
              <input type="hidden" name="selected_ids" value="{{ url.id }}" />
              <input type="hidden" name="q" value="{{ q }}" />
              <input type="hidden" name="tag" value="{{ tag }}" />
              <button type="submit" class="delete-btn">üóëÔ∏è Delete</button>
            </form>
            <button
              type="button"
              class="shodan-btn"
              data-url="{{ url.url }}"
            >
            üì°üõ∞Ô∏è Shodan
            </button>
            <button
              type="button"
              class="vt-btn"
              data-url="{{ url.url }}"
            >
            üíâvirustotal
            </button>
            <button
              type="button"
              class="postman-btn"
              data-url="{{ url.url }}"
            >
              ü§ñüì® postman
            </button>
            <button
              type="button"
              class="github-btn"
              data-url="{{ url.url }}"
            >
             üêôüê±‚Äçüíª github
            </button>
            <button
              type="button"
              class="google-btn"
              data-url="{{ url.url }}"
            >
              üî≠üá¨ google
            </button>
            <button
              type="button"
              class="crtsh-btn"
              data-url="{{ url.url }}"
            >
             üìà crt.sh
            </button>
            {% if url.url and url.url.endswith('.js.map') %}
            <form method="POST" action="/tools/webpack-zip" style="display:inline;margin:0;padding:0;">
              <input type="hidden" name="map_url" value="{{ url.url }}">
              <button type="submit" class="exploder-btn" title="Explode this JS.map file to ZIP" style="margin-left:0.3em;">Explode</button>
            </form>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </li>
      {% endfor %}
    </ul>
  </form>

  <div class="pagination">
    {% if page > 1 %}
      <a href="?page=1&q={{ q }}&tag={{ tag }}">‚èÆ First</a>
      <a href="?page={{ page - 1 }}&q={{ q }}&tag={{ tag }}">‚óÄ Prev</a>
    {% endif %}
    {% set start = page - 3 if page - 3 >= 1 else 1 %}
    {% set end = page + 3 if page + 3 <= total_pages else total_pages %}
    {% for p in range(start, end + 1) %}
      {% if p == page %}
        <strong>{{ p }}</strong>
      {% else %}
        <a href="?page={{ p }}&q={{ q }}&tag={{ tag }}">{{ p }}</a>
      {% endif %}
    {% endfor %}
    {% if page < total_pages %}
      <a href="?page={{ page + 1 }}&q={{ q }}&tag={{ tag }}">Next ‚ñ∂</a>
      <a href="?page={{ total_pages }}&q={{ q }}&tag={{ tag }}">Last ‚è≠</a>
    {% endif %}
  </div>
  {% else %}
  <p>No results found.</p>
  {% endif %}

  <script>
    // Dropdown toggle
    document.getElementById("main-dropdown-btn").addEventListener("click", function(e) {
      e.preventDefault();
      var dropdown = this.parentElement;
      dropdown.classList.toggle("show");
    });
    // Close dropdown when clicking outside
    document.addEventListener("click", function(event) {
      var dropdown = document.querySelector(".dropdown");
      if (dropdown && !dropdown.contains(event.target)) {
        dropdown.classList.remove('show');
      }
    });
    // Select All Matching logic
    function toggleSelectAllMatching(checkbox) {
      document.querySelector(
        'input[name="select_all_matching"]'
      ).value = checkbox.checked ? "true" : "false";
    }

    // Progress bar poller
    function updateImportProgressBar() {
      fetch('/import_progress').then(res => res.json()).then(data => {
        const block = document.getElementById('import-status-block');
        const bar = document.getElementById('import-progress-bar');
        const barContainer = document.getElementById('import-progress-bar-container');
        const numbers = document.getElementById('import-progress-numbers');
        const numbersSpan = document.getElementById('import-progress-numbers-span');
        const statusText = document.getElementById('import-status-text');

        // Reset bar color
        bar.style.background = '#cfcf22';

        if (['in_progress', 'starting', 'pending'].includes(data.status)) {
          block.style.display = '';
          barContainer.style.display = '';
          numbers.style.display = '';
          let pct = 0;
          if (data.total > 0) pct = Math.floor(100 * data.progress / data.total);
          bar.style.width = pct + "%";
          numbersSpan.textContent = `${data.progress}/${data.total}`;
          if (data.status == 'pending') statusText.textContent = "‚è≥ Pending...";
          else if (data.status == 'starting') statusText.textContent = "‚è≥ Starting...";
          else statusText.textContent = "‚è≥ In Progress...";
        } else if (data.status === 'done') {
          block.style.display = '';
          barContainer.style.display = '';
          bar.style.width = '100%';
          numbers.style.display = '';
          numbersSpan.textContent = `${data.progress}/${data.total}`;
          statusText.textContent = "‚úÖ Done!";
          setTimeout(() => {
            block.style.display = 'none';
          }, 2500);
        } else if (data.status === 'failed') {
          block.style.display = '';
          barContainer.style.display = '';
          bar.style.width = '100%';
          numbers.style.display = '';
          statusText.textContent = "‚ùå Failed: " + (data.detail || "");
          bar.style.background = '#f44336';
        } else {
          block.style.display = 'none';
          barContainer.style.display = 'none';
          numbers.style.display = 'none';
        }
      });
    }
    setInterval(updateImportProgressBar, 1000);
    window.addEventListener('DOMContentLoaded', updateImportProgressBar);

    // Button actions for shodan, crt.sh, etc
    document.addEventListener("DOMContentLoaded", function () {
      // Copy button
      document.querySelectorAll(".copy-btn").forEach((btn) => {
        btn.addEventListener("click", async function (e) {
          e.preventDefault();
          const urlToCopy = btn.getAttribute("data-url");
          if (!urlToCopy) return;
          try {
            await navigator.clipboard.writeText(urlToCopy);
            btn.textContent = "Copied!";
            setTimeout(() => (btn.textContent = "üìã Copy"), 1000);
          } catch (err) {
            const temp = document.createElement("textarea");
            temp.value = urlToCopy;
            temp.style.position = "fixed";
            temp.style.top = "-1000px";
            document.body.appendChild(temp);
            temp.focus();
            temp.select();
            try {
              document.execCommand("copy");
              btn.textContent = "Copied!";
              setTimeout(() => (btn.textContent = "üìã Copy"), 1000);
            } catch (_) {
              alert("Copy failed; please copy manually.");
            }
            document.body.removeChild(temp);
          }
        });
      });
      // Shodan, VT, Postman, Github, Google, crt.sh
      document.querySelectorAll(".shodan-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
          const url = btn.getAttribute("data-url");
          if (!url) return;
          window.open(`https://www.shodan.io/search?query=${encodeURIComponent(url)}`, '_blank');
        });
      });
      document.querySelectorAll(".vt-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
          const url = btn.getAttribute("data-url");
          if (!url) return;
          window.open(`https://www.virustotal.com/gui/search/${encodeURIComponent(url)}`, '_blank');
        });
      });
      document.querySelectorAll(".postman-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
          const url = btn.getAttribute("data-url");
          if (!url) return;
          window.open(`https://web.postman.co/workspace/personal/request/create?url=${encodeURIComponent(url)}`, '_blank');
        });
      });
      document.querySelectorAll(".github-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
          const url = btn.getAttribute("data-url");
          if (!url) return;
          window.open(`https://github.com/search?q=${encodeURIComponent(url)}`, '_blank');
        });
      });
      document.querySelectorAll(".google-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
          const url = btn.getAttribute("data-url");
          if (!url) return;
          window.open(`https://www.google.com/search?q=${encodeURIComponent(url)}`, '_blank');
        });
      });
      document.querySelectorAll(".crtsh-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
          const url = btn.getAttribute("data-url");
          if (!url) return;
          window.open(`https://crt.sh/?q=${encodeURIComponent(url)}`, '_blank');
        });
      });
    });
  </script>
  <footer class="footer" style="text-align:center; margin-top:2em; padding:0.5em; background:#f8f8f8; border-top:1px solid #ccc; font-size:0.9em;">
    <a href="https://github.com/thesavant42/wabax" target="_blank" style="text-decoration:none; color:#333;">
      WAYBAX: a yolosint production by thesavant42. Some rights reserved 2025.
    </a>
  </footer>
</body>
</html>