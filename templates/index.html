<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>retrorecon - {{ db_name }} - {{ total_count }} results</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='base.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='tools.css') }}" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css" />
  <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
  {% if current_theme %}
  {% if current_theme == 'terminal-sans-dark.css' %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/terminal.css@latest" />
  {% endif %}
  <link rel="stylesheet" href="{{ url_for('static', filename='themes/' + current_theme) }}" />
  {% endif %}
  {% if current_background %}
  <style>
    body {
      background: url('{{ url_for('static', filename='img/' + current_background) }}') no-repeat center center fixed;
      background-size: cover;
    }
  </style>
  {% endif %}
  <style>
    /* stylelint-disable */
    {% for t in themes %}
    {% set cols = theme_swatches.get(t) %}
    #theme-opt-{{ loop.index }} { background: {{ cols[0] }}; color: {{ cols[1] }}; }
    {% endfor %}
    /* stylelint-enable */
  </style>
  <link rel="shortcut icon" href="{{ url_for('core.favicon_ico') }}">
</head>
<body class="app">
  <div class="retrorecon-root">
    <div id="dropdown-shade" class="dropdown-shade hidden"></div>
{% macro render_pagination(page, total_pages, q, total_count, items_per_page, select_all_matching) %}
  <div class="pagination mt-05">
    <form id="set-items-form" method="POST" action="/set_items_per_page" class="d-none">
      <input type="hidden" name="count" id="items-count-input" />
    </form>
    <select id="results-per-page-select" class="form-select menu-btn" form="set-items-form">
      {% for n in [5,10,15,20,25] %}
      <option value="{{ n }}" {% if items_per_page == n %}selected{% endif %}>{{ '%02d' % n }}</option>
      {% endfor %}
    </select>
    <span class="page-info">Page {{ page }} of {{ total_pages }}</span>
    {% if page > 1 %}
      <a href="?page=1&q={{ q }}{% if select_all_matching %}&select_all_matching=true{% endif %}" class="pagination-arrow" aria-label="First">&laquo;&laquo;</a>
      <a href="?page={{ page - 1 }}&q={{ q }}{% if select_all_matching %}&select_all_matching=true{% endif %}" class="pagination-arrow" aria-label="Prev">&laquo;</a>
    {% endif %}
    {% set start = page - 2 if page - 2 > 2 else 1 %}
    {% set end = page + 2 if page + 2 < total_pages - 1 else total_pages %}
    {% if start > 1 %}
      <a href="?page=1&q={{ q }}{% if select_all_matching %}&select_all_matching=true{% endif %}">1</a>
      {% if start > 2 %}<span>...</span>{% endif %}
    {% endif %}
    {% for p in range(start, end + 1) %}
      {% if p == page %}
        <strong>{{ p }}</strong>
      {% else %}
        <a href="?page={{ p }}&q={{ q }}{% if select_all_matching %}&select_all_matching=true{% endif %}">{{ p }}</a>
      {% endif %}
    {% endfor %}
    {% if end < total_pages %}
      {% if end < total_pages - 1 %}<span>...</span>{% endif %}
      <a href="?page={{ total_pages }}&q={{ q }}{% if select_all_matching %}&select_all_matching=true{% endif %}">{{ total_pages }}</a>
    {% endif %}
    {% if page < total_pages %}
      <a href="?page={{ page + 1 }}&q={{ q }}{% if select_all_matching %}&select_all_matching=true{% endif %}" class="pagination-arrow" aria-label="Next">&raquo;</a>
      <a href="?page={{ total_pages }}&q={{ q }}{% if select_all_matching %}&select_all_matching=true{% endif %}" class="pagination-arrow" aria-label="Last">&raquo;&raquo;</a>
    {% endif %}
    <form class="d-inline ml-1" onsubmit="return gotoPage(this);">
      <input type="hidden" name="q" value="{{ q }}" />
      <input type="text" name="page" size="4" placeholder="Page" class="form-input" />
    </form>
    <span class="total-count">Total results: {{ total_count }}</span>
  </div>
  {% endmacro %}
  <nav class="navbar">
  <div class="navbar__menus">
    <div class="dropdown">
      <button class="dropbtn" data-menu="file-menu">File ▼</button>
      <div class="dropdown-content" id="file-menu">
          <form method="POST" action="/new_db" class="menu-row" id="new-db-form">
            <input type="hidden" name="db_name" id="new-db-name" />
            <button type="submit" class="menu-btn">New Project</button>
          </form>
          <div class="menu-row"><a href="/save_db?name={{ db_name }}" class="menu-btn">Save Project</a></div>
          <form method="GET" action="/save_db" class="menu-row" id="save-db-form">
            <button type="submit" class="menu-btn">Save Project As...</button>
          </form>
          <form method="POST" action="/load_saved_db" class="menu-row" id="load-saved-db-form">
            <select name="db_file" id="load-saved-db-select" class="form-select menu-btn">
              <option value="">Open Project...</option>
              {% for db in saved_dbs %}
              <option value="{{ db }}">{{ db }}</option>
              {% endfor %}
            </select>
          </form>
          <select id="url-export-formats" class="form-select menu-btn">
            <option value="" selected>Export As...</option>
            <option value="json">JSON</option>
            <option value="csv">CSV</option>
            <option value="md">Markdown</option>
            <option value="xml">XML</option>
            <option value="txt">Plain Text</option>
          </select>
          <form id="url-export-form" class="hidden" action="/export_urls" method="GET" target="_blank">
            <input type="hidden" name="format" id="url-export-format" />
            <input type="hidden" name="q" id="url-export-q" value="{{ q }}" />
            <input type="hidden" name="select_all_matching" id="url-export-sam" value="{{ 'true' if select_all_matching else 'false' }}" />
          </form>
          <div class="menu-row"><a href="/save_db?name={{ db_name }}" class="menu-btn">Backup SQL</a></div>
      </div>
    </div>
    <div class="dropdown">
      <button class="dropbtn" data-menu="edit-menu">Edit ▼</button>
      <div class="dropdown-content" id="edit-menu">
          <div class="menu-row"><button class="menu-btn bulk-action-btn" type="button" onclick="toggleSelectAllPage({})">Select All (All visible results)</button></div>
          <div class="menu-row"><button class="menu-btn bulk-action-btn" type="button" onclick="toggleSelectAllMatching({checked:true})">Select All (All matching results)</button></div>
          <div class="menu-row"><button class="menu-btn bulk-action-btn" type="submit" form="bulk-form" name="action" value="delete">Delete Selected</button></div>
          <div class="menu-row"><button class="menu-btn bulk-action-btn" type="submit" form="bulk-form" name="action" value="clear_tags">Reset tags Selected</button></div>
          <div class="menu-row bulk-controls">
            <input type="text" name="tag" id="bulk-tag-input" form="bulk-form" placeholder="Tag" class="form-input tag-input" />
            <button class="menu-btn bulk-action-btn" type="submit" form="bulk-form" name="action" value="add_tag">Add Tag to Selected</button>
          </div>
          <div class="menu-header">Preferences</div>
          <form id="set-theme-form" method="POST" action="/set_theme" class="d-none">
            <input type="hidden" name="theme" id="set-theme-input" />
          </form>
          <form id="set-bg-form" method="POST" action="/set_background" class="d-none">
            <input type="hidden" name="background" id="set-bg-input" />
          </form>
          <div class="theme-row menu-row mb-4px">
            <label for="theme-select" class="form-label menu-label">Theme:</label>
            <select id="theme-select" class="form-select menu-btn">
              {% for t in themes %}
              {% set cols = theme_swatches.get(t) %}
              <option id="theme-opt-{{ loop.index }}" value="{{ t }}" {% if t == current_theme %}selected{% endif %}>
                {{ t.replace('theme-','').replace('.css','') }}
              </option>
              {% endfor %}
            </select>
          </div>
          <div class="menu-row mb-4px">
            <label for="background-select" class="form-label menu-label">Background:</label>
            <select id="background-select" class="form-select menu-btn">
              {% for bg in backgrounds %}
              <option value="{{ bg }}" {% if bg == current_background %}selected{% endif %}>{{ bg }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="menu-row">
            <label class="form-label menu-label">
              <input type="checkbox" id="bg-toggle" checked onchange="toggleBackground(this)" class="form-checkbox">
              Show background image
            </label>
          </div>
          <div class="menu-row mb-4px">
            <label for="font-size-input" class="form-label menu-label">Font size:</label>
            <input type="number" id="font-size-input" min="10" max="18" step="1" value="14" class="form-input w-6em">
          </div>
          <div class="menu-row">
            <label for="opacity-range" class="form-label menu-label">Panel opacity:</label>
            <input type="range" id="opacity-range" min="10" max="100" value="{{ (panel_opacity * 100)|int }}" class="form-range">
          </div>
          <hr>
          <div class="menu-row mb-4px">
            <label for="font-family-select" class="form-label menu-label">Font:</label>
            <select id="font-family-select" class="form-select menu-btn">
              <option value="monospace">monospace</option>
              <option value="sans-serif">sans-serif</option>
              <option value="serif">serif</option>
            </select>
          </div>
          <div class="menu-row mb-4px">
            <label for="accent-color-input" class="form-label menu-label">Accent:</label>
            <input type="color" id="accent-color-input" class="form-input menu-btn" value="#00aaff">
          </div>
          <div class="menu-row mb-4px">
            <label for="text-color-input" class="form-label menu-label">Text:</label>
            <input type="color" id="text-color-input" class="form-input menu-btn" value="#ffffff">
          </div>
          <div class="menu-row mb-4px">
            <label for="bg-color-input" class="form-label menu-label">Background:</label>
            <input type="color" id="bg-color-input" class="form-input menu-btn" value="#000000">
          </div>
          <div class="menu-row mb-4px">
            <label for="border-color-input" class="form-label menu-label">Border:</label>
            <input type="color" id="border-color-input" class="form-input menu-btn" value="#888888">
          </div>
          <div class="menu-row">
            <button type="button" id="save-theme-btn" class="menu-btn">Save Theme</button>
          </div>
      </div>
    </div>
    <div class="dropdown">
      <button class="dropbtn" data-menu="tools-menu">Tools ▼</button>
      <div class="dropdown-content" id="tools-menu">
          <div class="menu-header">OSINT</div>
          <div class="menu-row"><a href="#" class="menu-btn" id="subdomonster-link">Subdomonster</a></div>
          <form method="POST" action="/fetch_cdx" class="menu-row" id="fetch-cdx-form">
            <input id="domain-input" type="hidden" name="domain" />
            <button type="button" class="menu-btn" id="fetch-cdx-btn">Hindsight (CDX API)</button>
          </form>
          <div class="menu-row"><a href="#" class="menu-btn" id="oci-explorer-link">OCI Explorer</a></div>
          <div class="menu-header">Active Recon</div>
          <div class="menu-row"><a href="#" class="menu-btn" id="screenshot-link">Screenshotter</a></div>
          <div class="menu-row"><a href="#" class="menu-btn" id="httpolaroid-link">HTTPolaroid</a></div>
          <div class="menu-header">Utilities</div>
          <div class="menu-row"><a href="#" class="menu-btn" id="text-tools-link">Text Tools</a></div>
          <div class="menu-row"><a href="#" class="menu-btn" id="jwt-tools-link">JWT Tools</a></div>
          <form method="POST" action="/tools/webpack-zip" class="menu-row" id="webpack-form">
            <input type="hidden" name="map_url" id="webpack-url-input" />
            <button type="button" class="menu-btn" id="webpack-btn">Webpack Exploder</button>
          </form>
      </div>
    </div>
    <div class="dropdown">
      <button class="dropbtn" data-menu="help-menu">Help ▼</button>
      <div class="dropdown-content" id="help-menu">
          <div class="menu-row"><a href="#" class="menu-btn" id="help-readme-link">README</a></div>
          <div class="menu-row"><a href="#" class="menu-btn" id="help-about-link">About</a></div>
      </div>
    </div>
  </div>
  <div class="navbar__title">
      <span class="cursor-pointer" id="db-display">[ {{ db_name }} ]</span>
      <form method="POST" action="/load_saved_db" id="load-saved-db-bar-form" class="ml-5px">
        <select name="db_file" id="load-saved-db-bar-select" class="form-select menu-btn">
          <option value="">Load Saved DB...</option>
          {% for db in saved_dbs %}
          <option value="{{ db }}">{{ db }}</option>
          {% endfor %}
        </select>
      </form>
    </div>
    <div class="navbar__info">
      <div id="import-status-block" class="db-info">
        <span class="ml-01"><strong>Status:</strong></span>
        <span id="import-status-text">idle</span>
        <div id="import-progress-bar-container" class="d-none">
          <div id="import-progress-bar"></div>
        </div>
        <div id="import-progress-numbers" class="mt-05 d-none">
          <span id="import-progress-numbers-span"></span>
        </div>
      </div>
    </div>
  </nav>

  <!-- Table B : Search bar and buttons -->
  <div class="search-bar">
    <form method="GET" action="/" id="search-form">
      <div class="search-input-row">
        <input type="text" name="q" placeholder="Search..." value="{{ q }}" id="searchbox" class="w-100 form-input tag-input" />
        <div class="search-buttons">
          <button type="submit" class="btn">Search</button>
          <button type="button" id="save-tag-btn" class="btn">+🏷️</button>
          <button type="button" id="clear-search-btn" class="btn">Clear</button>
          <button type="button" id="manage-tags-btn" class="btn">Tags…</button>
        </div>
      </div>
    </form>
  </div>

  <!-- Table C : Pagination and saved tags -->
  <table id="layout-c" class="w-100 mt-05">
    <tr>
      <td class="text-left">
        {{ render_pagination(page, total_pages, q, total_count, items_per_page, select_all_matching) }}
      </td>
    </tr>
  </table>

  <!-- Table D : Results -->
  <div id="layout-d" class="w-100 mt-1">
    <div class="results-grid results-frame table-container">

          {% if urls %}
          <form method="POST" action="/bulk_action" id="bulk-form">
            <input type="hidden" name="q" value="{{ q }}" />
            <input type="hidden" name="select_all_matching" id="select-all-matching-input" value="{{ 'true' if select_all_matching else 'false' }}" />

            <!-- Data table -->
            <table class="url-table">
              <colgroup>
                <col class="w-2em" />
                <col />
                <col />
                <col />
                <col />
              </colgroup>
              <thead>
                <tr>
                  <th class="w-2em no-resize text-center">
                    <input type="checkbox" id="select-all-rows" onchange="toggleSelectAllRows(this)" onclick="event.stopPropagation()" class="form-checkbox" />
                  </th>
                  <th class="sortable" data-sort="url">URL{% if current_sort=='url' %} {{ '▲' if current_dir=='asc' else '▼' }}{% endif %}</th>
                  <th class="text-center sortable" data-sort="timestamp">Timestamp{% if current_sort=='timestamp' %} {{ '▲' if current_dir=='asc' else '▼' }}{% endif %}</th>
                  <th class="text-center sortable" data-sort="status_code">HTTP{% if current_sort=='status_code' %} {{ '▲' if current_dir=='asc' else '▼' }}{% endif %}</th>
                  <th class="text-center sortable" data-sort="mime_type">MIME{% if current_sort=='mime_type' %} {{ '▲' if current_dir=='asc' else '▼' }}{% endif %}</th>
                </tr>
              </thead>
              <tbody>
                {% for url in urls %}
                <tr class="url-row-main url-result cursor-pointer" data-url="{{ url.url }}">
                  <td class="checkbox-col">
                    <input type="checkbox" class="row-checkbox" name="selected_ids" value="{{ url.id }}" onclick="event.stopPropagation()" />
                  </td>
                  <td class="url-result"><div class="cell-content">{{ url.url }}</div></td>
                  <td class="text-center"><div class="cell-content">
                    {% if url.timestamp %}
                    <span title="{{ url.timestamp }}">{{ url.timestamp|wb_timestamp }}</span>
                    {% else %}-{% endif %}
                  </div></td>
                  <td class="status text-center {% if url.status_code %}status-{{ (url.status_code|string)[:1] }}{% endif %}"><div class="cell-content">{{ url.status_code if url.status_code else '-' }}</div></td>
                  <td class="text-center"><div class="cell-content">{{ url.mime_type or '-' }}</div></td>
                </tr>
                <tr class="url-row-buttons">
                  <td></td>
                  <td colspan="4">
                    <div class="url-tools-row nowrap">
                      <select class="form-select tool-select menu-btn" data-url="{{ url.url }}">
                        <option value="">Tools…</option>
                        <option value="archive">Web Archive</option>
                        <option value="shodan">Shodan.io</option>
                        <option value="vt">VirusTotal</option>
                        <option value="github">GitHub</option>
                        <option value="google">Google Search</option>
                        <option value="crtsh">Crt.sh</option>
                        <option value="explode" {% if '.js.map' not in url.url %}disabled{% endif %}>Webpack Exploder</option>
                      </select>
                      <button class="btn explode-btn copy-btn" type="button" data-url="{{ url.url }}" title="Copy">📋 Copy</button>
                      <form method="POST" action="/bulk_action" class="d-inline mr-03">
                        <input type="hidden" name="action" value="delete" />
                        <input type="hidden" name="selected_ids" value="{{ url.id }}" />
                        <input type="hidden" name="q" value="{{ q }}" />
                        <button type="submit" class="btn delete-btn" title="Delete">🗑️ Delete</button>
                      </form>
                      <button type="button" class="btn ml-05 notes-btn" data-url-id="{{ url.id }}" onclick="openNotes(this)">📝 Notes</button>
                      <form method="POST" action="/bulk_action" class="d-inline ml-05">
                        <input type="hidden" name="action" value="add_tag" />
                        <input type="hidden" name="selected_ids" value="{{ url.id }}" />
                        <input type="text" name="tag" placeholder="Tag" size="8" required class="form-input tag-input row-tag-input" />
                        <button type="submit" title="Add tag" class="btn">+</button>
                      </form>
                      {% for tag in (url.tags or '').split(',') if tag %}
                      <span class="tag-pill">{{ tag }}
                        <form method="POST" action="/bulk_action" class="d-inline">
                          <input type="hidden" name="action" value="remove_tag" />
                          <input type="hidden" name="tag" value="{{ tag }}" />
                          <input type="hidden" name="selected_ids" value="{{ url.id }}" />
                          <button type="submit" title="Remove tag" class="btn">&times;</button>
                        </form>
                      </span>
                      {% endfor %}
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </form>
          {% else %}
            <div class="m-2em text-center results-grid__no-results">No URLs found for this query.</div>
          {% endif %}
        </div>

  <div class="bottom-container text-center mt-05">
    {{ render_pagination(page, total_pages, q, total_count, items_per_page, select_all_matching) }}
    <div class="footer">
      <a href="https://github.com/thesavant42/retrorecon" target="_blank" class="no-underline text-muted">
        retrorecon - v{{ app_version }} by @savant42 &copy; 2025
      </a>
    </div>
  </div>

  <div id="notes-overlay" class="notes-overlay hidden">
    <textarea id="note-input" class="form-input notes-textarea" rows="6" placeholder="Add a note..."></textarea>
    <div class="mt-05">
      <button type="button" class="btn" id="note-save-btn">Save</button>
      <button type="button" class="btn" id="delete-all-notes-btn">Delete All</button>
      <button type="button" class="btn" id="note-close-btn">Close</button>
    </div>
    <div id="notes-list" class="notes-list mt-05"></div>
  </div>

  <div id="tags-overlay" class="tags-overlay hidden">
    <div class="tag-toolbar">
      <input type="text" id="tag-search-input" class="form-input tag-input" placeholder="Search tags..." />
      <button type="button" class="btn" id="tag-new-btn">New</button>
      <button type="button" class="btn" id="tag-close-btn">Close</button>
    </div>
    <div id="tag-editor" class="mt-05 hidden">
      <input type="text" id="tag-name-input" class="form-input tag-input" placeholder="Tag name" />
      <input type="color" id="tag-color-input" value="#cccccc" class="ml-05" />
      <input type="text" id="tag-desc-input" class="form-input tag-input mt-05" placeholder="Description" />
      <div class="mt-05">
        <button type="button" class="btn" id="tag-save-btn">Save</button>
        <button type="button" class="btn" id="tag-cancel-btn">Cancel</button>
      </div>
    </div>
    <div id="tags-list" class="notes-list mt-05"></div>
  </div>

  <script>
    const totalResultsCount = {{ total_count }};

    const notesOverlay = document.getElementById('notes-overlay');
    const noteInput = document.getElementById('note-input');
    const notesList = document.getElementById('notes-list');
    const noteSaveBtn = document.getElementById('note-save-btn');
    const noteCloseBtn = document.getElementById('note-close-btn');
    const deleteAllBtn = document.getElementById('delete-all-notes-btn');
    const tagsOverlay = document.getElementById('tags-overlay');
    const tagSearchInput = document.getElementById('tag-search-input');
    const tagNameInput = document.getElementById('tag-name-input');
    const tagDescInput = document.getElementById('tag-desc-input');
    const tagColorInput = document.getElementById('tag-color-input');
    const tagEditor = document.getElementById('tag-editor');
    const tagsList = document.getElementById('tags-list');
    const tagSaveBtn = document.getElementById('tag-save-btn');
    const tagCancelBtn = document.getElementById('tag-cancel-btn');
    const tagNewBtn = document.getElementById('tag-new-btn');
    const tagCloseBtn = document.getElementById('tag-close-btn');
    let editingTag = null;
    let allTags = [];
    let currentUrlId = null;
    let editingId = null;

    function renderNotes(data){
      notesList.innerHTML = '';
      data.forEach(n => {
        const div = document.createElement('div');
        div.className = 'note-item';
        const text = document.createElement('span');
        text.textContent = n.content;
        div.appendChild(text);
        const actions = document.createElement('div');
        actions.className = 'notes-actions';
        const edit = document.createElement('a');
        edit.href = '#';
        edit.className = 'notes-link';
        edit.textContent = 'Edit';
        edit.addEventListener('click', e => {
          e.preventDefault();
          noteInput.value = n.content;
          editingId = n.id;
        });
        const del = document.createElement('a');
        del.href = '#';
        del.className = 'notes-link ml-05';
        del.textContent = 'Delete';
        del.addEventListener('click', e => {
          e.preventDefault();
          if(confirm('Delete note?')){
            fetch('/delete_note', {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:new URLSearchParams({note_id:n.id})}).then(loadNotes);
          }
        });
        actions.appendChild(edit);
        actions.appendChild(del);
        div.appendChild(actions);
        notesList.appendChild(div);
      });
    }

    function loadNotes(){
      fetch('/notes/' + currentUrlId).then(r=>r.json()).then(renderNotes);
    }

    function openNotes(btn){
      currentUrlId = btn.getAttribute('data-url-id');
      editingId = null;
      noteInput.value = '';
      loadNotes();
      notesOverlay.classList.remove('hidden');
    }

    noteSaveBtn.addEventListener('click', () => {
      const content = noteInput.value.trim();
      if(!content) return;
      const params = new URLSearchParams({url_id: currentUrlId, content: content});
      if(editingId) params.set('note_id', editingId);
      fetch('/notes', {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: params}).then(()=>{noteInput.value=''; editingId=null; loadNotes();});
    });

    noteCloseBtn.addEventListener('click', () => { notesOverlay.classList.add('hidden'); });
    document.addEventListener('keydown', (e) => {
      if(e.key === 'Escape' && !notesOverlay.classList.contains('hidden')){
        noteCloseBtn.click();
      }
    });

    deleteAllBtn.addEventListener('click', () => {
      if(confirm('Delete all notes?')){
        fetch('/delete_note', {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:new URLSearchParams({url_id: currentUrlId, all:'1'})}).then(loadNotes);
      }
    });

    function renderTags(list){
      tagsList.innerHTML = '';
      list.sort((a,b)=>a.name.localeCompare(b.name));
      list.forEach(t => {
        const div = document.createElement('div');
        div.className = 'tag-item';
        const span = document.createElement('span');
        span.className = 'saved-tag';
        span.textContent = t.name;
        span.style.backgroundColor = t.color || '#ccc';
        div.appendChild(span);
        const actions = document.createElement('div');
        actions.className = 'notes-actions';
        const edit = document.createElement('a');
        edit.href = '#';
        edit.className = 'notes-link';
        edit.textContent = 'Edit';
        edit.addEventListener('click', e => {
          e.preventDefault();
          editingTag = t;
          tagNameInput.value = t.name;
          tagColorInput.value = t.color || '#cccccc';
          tagDescInput.value = t.desc || '';
          tagEditor.classList.remove('hidden');
        });
        const del = document.createElement('a');
        del.href = '#';
        del.className = 'notes-link ml-05';
        del.textContent = 'Delete';
        del.addEventListener('click', e => {
          e.preventDefault();
          if(confirm('Delete tag?')){
            fetch('/delete_saved_tag', {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:new URLSearchParams({tag:t.name})}).then(loadTags);
          }
        });
        actions.appendChild(edit);
        actions.appendChild(del);
        div.appendChild(actions);
        tagsList.appendChild(div);
      });
      if(searchTagify) searchTagify.settings.whitelist = list.map(x => x.name);
    }

    function loadTags(){
      fetch('/saved_tags').then(r=>r.json()).then(d=>{
        allTags = Array.isArray(d.tags) ? d.tags : [];
        applySearch();
      });
    }

    function applySearch(){
      const term = tagSearchInput.value.trim().toLowerCase();
      const filtered = term ? allTags.filter(t => t.name.toLowerCase().includes(term)) : allTags;
      renderTags(filtered);
    }

    function openTags(){
      tagEditor.classList.add('hidden');
      tagSearchInput.value = '';
      editingTag = null;
      loadTags();
      tagsOverlay.classList.remove('hidden');
      tagsOverlay.classList.add('show');
    }

    tagSearchInput.addEventListener('input', applySearch);

    tagNewBtn.addEventListener('click', () => {
      editingTag = null;
      tagNameInput.value = '';
      tagColorInput.value = '#cccccc';
      tagDescInput.value = '';
      tagEditor.classList.remove('hidden');
    });

    tagSaveBtn.addEventListener('click', () => {
      const name = tagNameInput.value.trim();
      if(!name) return;
      const params = new URLSearchParams({color: tagColorInput.value, desc: tagDescInput.value});
      if(!name.startsWith('#')) params.set(editingTag ? 'new_tag' : 'tag', '#' + name); else params.set(editingTag ? 'new_tag' : 'tag', name);
      if(editingTag){
        params.set('old_tag', editingTag.name);
        fetch('/rename_saved_tag', {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:params}).then(()=>{tagEditor.classList.add('hidden'); loadTags();});
      }else{
        fetch('/saved_tags', {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:params}).then(()=>{tagEditor.classList.add('hidden'); loadTags();});
      }
    });

    tagCancelBtn.addEventListener('click', () => { tagEditor.classList.add('hidden'); });

    tagCloseBtn.addEventListener('click', () => { tagsOverlay.classList.add('hidden'); tagsOverlay.classList.remove('show'); });
    document.getElementById('manage-tags-btn').addEventListener('click', openTags);
    document.addEventListener('keydown', e => {
      if(e.key === 'Escape' && !tagsOverlay.classList.contains('hidden')){
        tagCloseBtn.click();
      }
    });

    const dropdownShade = document.getElementById('dropdown-shade');
    document.querySelectorAll('.dropbtn').forEach(btn => {
      btn.addEventListener('click', function(e){
        e.preventDefault();
        const item = this.parentElement;
        const show = !item.classList.contains('show');
        document.querySelectorAll('.dropdown').forEach(it => it.classList.remove('show'));
        if(show){
          item.classList.add('show');
          dropdownShade.classList.add('show');
        } else {
          dropdownShade.classList.remove('show');
        }
      });
    });
    document.addEventListener('click', function(e){
      if(!e.target.closest('.dropdown')){
        document.querySelectorAll('.dropdown').forEach(it => it.classList.remove('show'));
        dropdownShade.classList.remove('show');
      }
    });
    dropdownShade.addEventListener('click', () => {
      document.querySelectorAll('.dropdown').forEach(it => it.classList.remove('show'));
      dropdownShade.classList.remove('show');
    });

    function closeMenus(){
      document.querySelectorAll('.dropdown').forEach(it => it.classList.remove('show'));
      dropdownShade.classList.remove('show');
    }

    function toggleSelectAllPage(cb) {
      const boxes = document.querySelectorAll('.row-checkbox');
      let state = cb.checked;
      if(state === undefined){
        state = !Array.from(boxes).every(c => c.checked);
      }
      boxes.forEach(c => c.checked = state);
      const matchCb = document.getElementById('select-all-matching');
      if(matchCb) matchCb.checked = false;
      document.getElementById('select-all-matching-input').value = "false";
      const url = new URL(window.location);
      url.searchParams.delete('select_all_matching');
      window.history.replaceState(null, '', url);
      showStatus(state ? `${boxes.length} selected` : 'Selection cleared');
    }

    function toggleSelectAllMatching(cb) {
      document.getElementById('select-all-matching-input').value = cb.checked ? "true" : "false";
      const pageCb = document.getElementById('select-all-page');
      if(pageCb) pageCb.checked = false;
      if (cb.checked) {
        document.querySelectorAll('.row-checkbox').forEach(c => c.checked = true);
        showStatus(`${totalResultsCount} selected`);
      } else {
        showStatus('Selection cleared');
      }
      const url = new URL(window.location);
      if(cb.checked){
        url.searchParams.set('select_all_matching', 'true');
      } else {
        url.searchParams.delete('select_all_matching');
      }
      window.history.replaceState(null, '', url);
    }

    function toggleSelectAllRows(cb) {
      document.querySelectorAll('.row-checkbox').forEach(c => c.checked = cb.checked);
    }

    var bulkForm = document.getElementById('bulk-form');
    if (bulkForm) {
      bulkForm.addEventListener('submit', function(e){
        const action = e.submitter ? e.submitter.value : '';
        if (action === 'delete') {
          if (document.getElementById('select-all-matching-input').value !== 'true') {
            const checked = document.querySelectorAll('.row-checkbox:checked');
            if (checked.length === 0) {
              alert('Please select at least one entry to delete.');
              e.preventDefault();
            }
          }
        } else if (['add_tag','remove_tag'].includes(action)) {
          if (!document.getElementById('bulk-tag-input').value.trim()) {
            alert('Please enter a tag.');
            e.preventDefault();
          }
        }
      });
    }

    function gotoPage(f) {
      const p = f.page.value.trim();
      if(p) {
        const params = new URLSearchParams();
        if(f.q && f.q.value) params.set('q', f.q.value);
        if(document.getElementById('select-all-matching-input').value === 'true') {
          params.set('select_all_matching', 'true');
        }
        params.set('page', p);
        window.location = '/?' + params.toString();
      }
      return false;
    }

    function handleToolSelect(sel, url){
      const val = sel.value;
      sel.selectedIndex = 0;
      if(!val) return;
      let link = '';
      switch(val){
        case 'archive':
          link = 'https://web.archive.org/web/*/' + encodeURIComponent(url);
          break;
        case 'shodan':
          link = 'https://www.shodan.io/search?query=' + encodeURIComponent(url);
          break;
        case 'vt':
          link = 'https://www.virustotal.com/gui/search/' + encodeURIComponent(url);
          break;
        case 'github':
          link = 'https://github.com/search?q=' + encodeURIComponent(url);
          break;
        case 'google':
          link = 'https://www.google.com/search?q=site:' + encodeURIComponent(url);
          break;
        case 'crtsh':
          link = 'https://crt.sh/?q=' + encodeURIComponent(url);
          break;
        case 'explode':
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = '/tools/webpack-zip';
          form.target = '_blank';
          const inp = document.createElement('input');
          inp.type = 'hidden';
          inp.name = 'map_url';
          inp.value = url;
          form.appendChild(inp);
          document.body.appendChild(form);
          form.submit();
          document.body.removeChild(form);
          return;
      }
      if(link) window.open(link, '_blank');
    }

    document.querySelectorAll('.copy-btn').forEach(b => {
      b.addEventListener('click', async () => {
        const url = b.getAttribute('data-url');
        try {
          await navigator.clipboard.writeText(url);
          b.textContent = 'Copied!';
          setTimeout(() => { b.textContent = '📋 Copy'; }, 1000);
        } catch {
          const t = document.createElement('textarea');
          t.value = url;
          document.body.appendChild(t);
          t.select();
          document.execCommand('copy');
          document.body.removeChild(t);
          b.textContent = 'Copied!';
          setTimeout(() => { b.textContent = '📋 Copy'; }, 1000);
        }
      });
    });

    function updateImportStatus(data){
      const block = document.getElementById('import-status-block');
      const text = document.getElementById('import-status-text');
      const barContainer = document.getElementById('import-progress-bar-container');
      const bar = document.getElementById('import-progress-bar');
      const nums = document.getElementById('import-progress-numbers');
      const span = document.getElementById('import-progress-numbers-span');
      const status = (data && data.status) ? data.status : 'idle';
      text.textContent = data.detail || status;
      block.style.display = 'flex';
      if(status === 'idle'){
        barContainer.classList.add('d-none');
        nums.classList.add('d-none');
        bar.style.width = '0';
      } else {
        barContainer.classList.remove('d-none');
        if(data.total){
          nums.classList.remove('d-none');
          const pct = Math.floor(data.progress / data.total * 100);
          bar.style.width = pct + '%';
          span.textContent = data.progress + '/' + data.total;
        } else {
          nums.classList.add('d-none');
        }
      }
    }

    let importPollTimer = null;
    function pollImport() {
      fetch('/import_progress')
        .then(r => r.json())
        .then(data => {
          updateImportStatus(data);
          if (data.status && data.status !== 'idle') {
            if (['done', 'failed'].includes(data.status)) {
              fetch('/import_progress?clear=1').then(() => {
                clearTimeout(importPollTimer);
                importPollTimer = null;
                setTimeout(() => { window.location.reload(); }, 1000);
              });
              return;
            }
            importPollTimer = setTimeout(pollImport, 2000);
          }
        })
        .catch(() => { importPollTimer = setTimeout(pollImport, 5000); });
    }

    function startImportPolling(){
      if(!importPollTimer){
        pollImport();
      }
    }

    let statusTimer = null;
    let statusClear = null;
    let statusDelay = 1000;
    function showStatus(msg){
      const text = document.getElementById('import-status-text');
      text.textContent = msg;
      if(statusClear) clearTimeout(statusClear);
      statusClear = setTimeout(() => { text.textContent = 'idle'; }, 3000);
    }

    function pollStatus(){
      fetch('/status')
        .then(r => r.json())
        .then(data => {
          if(data.code){
            showStatus(data.message || data.code);
            statusDelay = 1000;
          } else {
            statusDelay = Math.min(statusDelay * 2, 30000);
          }
          statusTimer = setTimeout(pollStatus, statusDelay);
        })
        .catch(() => {
          statusDelay = 5000;
          statusTimer = setTimeout(pollStatus, statusDelay);
        });
    }

    pollStatus();

    // Check once on load and show current status
    fetch('/import_progress')
      .then(r => r.json())
      .then(data => {
        updateImportStatus(data);
        if (data.status && data.status !== 'idle') startImportPolling();
      })
      .catch(() => { updateImportStatus({status:'idle'}); });

    let searchTagify;
    async function initSearchTags(){
      let saved = [];
      try {
        const resp = await fetch('/saved_tags');
        if(resp.ok){
          const data = await resp.json();
          const arr = Array.isArray(data.tags) ? data.tags : [];
          saved = arr.map(t => t.name);
        }
      } catch(e){}
      const input = document.getElementById('searchbox');
      if(input){
        searchTagify = new Tagify(input, {mode:'mix', pattern:/#\w+/, whitelist:saved});
      }
    }

    function saveTag(){
      let val = document.getElementById('searchbox').value.trim();
      if(!val) return;
      if(!val.startsWith('#')){
        val = '#' + val;
      }
      fetch('/saved_tags', {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:new URLSearchParams({tag:val})})
        .then(() => { if(searchTagify && !searchTagify.settings.whitelist.includes(val)) searchTagify.settings.whitelist.push(val); });
    }

    document.getElementById('save-tag-btn').addEventListener('click', saveTag);
    const searchForm = document.getElementById('search-form');
    const searchInput = document.getElementById('searchbox');
    const clearBtn = document.getElementById('clear-search-btn');
    if (searchInput && searchForm) {
      searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          searchForm.submit();
        }
      });
    }
    if (clearBtn) {
      clearBtn.addEventListener('click', () => {
        if (searchTagify) {
          searchTagify.removeAllTags();
        }
        if (searchInput) {
          searchInput.value = '';
        }
        if (searchForm) {
          searchForm.submit();
        }
      });
    }
    initSearchTags();

    const saveForm = document.getElementById('save-db-form');
    if (saveForm) {
      saveForm.addEventListener('submit', function(e) {
        if (!/name=/.test(this.action)) {
          e.preventDefault();
          const nm = prompt('Enter database name:', 'waybax');
          if (nm) {
            const enc = encodeURIComponent(nm.trim());
            window.location = '/save_db?name=' + enc;
          }
        }
      });
    }

    const newForm = document.getElementById('new-db-form');
    if (newForm) {
      newForm.addEventListener('submit', function(e) {
        const input = document.getElementById('new-db-name');
        if (!input.value.trim()) {
          e.preventDefault();
          const nm = prompt('Enter new database name:', 'waybax');
          if (nm) {
            const cleaned = nm.replace(/[^A-Za-z0-9_-]/g, '').slice(0, 64);
            if (cleaned) {
              input.value = cleaned;
              this.submit();
            }
          }
        }
      });
    }

    const renameForm = document.getElementById('rename-db-form');
    if (renameForm) {
      renameForm.addEventListener('submit', function(e) {
        const input = document.getElementById('rename-db-name');
        if (!input.value.trim()) {
          e.preventDefault();
          const nm = prompt('Enter new database name:', 'waybax');
          if (nm) {
            const cleaned = nm.replace(/[^A-Za-z0-9_-]/g, '').slice(0, 64);
            if (cleaned) {
              input.value = cleaned;
              this.submit();
            }
          }
        }
      });
    }

    const loadBtn = document.getElementById('load-db-btn');
    const loadInput = document.getElementById('load-db-file');
    const loadForm = document.getElementById('load-db-form');
    if (loadBtn && loadInput && loadForm) {
      loadBtn.addEventListener('click', () => loadInput.click());
      const dbDisplay = document.getElementById('db-display');
      if (dbDisplay) {
        dbDisplay.addEventListener('click', () => loadInput.click());
      }
      loadInput.addEventListener('change', () => {
        if (loadInput.files.length) {
          loadForm.submit();
        }
      });
    }

    const savedSelect = document.getElementById('load-saved-db-select');
    const savedForm = document.getElementById('load-saved-db-form');
    if (savedSelect && savedForm) {
      savedSelect.addEventListener('change', () => {
        if (savedSelect.value) {
          savedForm.submit();
        }
      });
    }
    const savedBarSelect = document.getElementById('load-saved-db-bar-select');
    const savedBarForm = document.getElementById('load-saved-db-bar-form');
    if (savedBarSelect && savedBarForm) {
      savedBarSelect.addEventListener('change', () => {
        if (savedBarSelect.value) {
          savedBarForm.submit();
        }
      });
    }

    const importBtn = document.getElementById('import-file-btn');
    const importInput = document.getElementById('import-file-input');
    const importForm = document.getElementById('import-form');
    if (importBtn && importInput && importForm) {
      importBtn.addEventListener('click', () => importInput.click());
      importInput.addEventListener('change', () => {
        if (importInput.files.length) {
          startImportPolling();
          importForm.submit();
        }
      });
    }

    const fetchBtn = document.getElementById('fetch-cdx-btn');
    const fetchInput = document.getElementById('domain-input');
    const fetchForm = document.getElementById('fetch-cdx-form');
    if (fetchBtn && fetchInput && fetchForm) {
      fetchBtn.addEventListener('click', () => {
        const domain = prompt('Enter domain to fetch from CDX:');
        if (domain) {
          fetchInput.value = domain;
          fetchForm.submit();
        }
      });
    }

    const webpackBtn = document.getElementById('webpack-btn');
    const webpackInput = document.getElementById('webpack-url-input');
    const webpackForm = document.getElementById('webpack-form');
      if (webpackBtn && webpackInput && webpackForm) {
        webpackBtn.addEventListener('click', () => {
          const url = prompt('Enter .js.map URL to explode:');
          if (url) {
            webpackInput.value = url;
            webpackForm.submit();
          }
        });
      }

      const openTool = "{{ open_tool or '' }}";

      const textToolsLink = document.getElementById('text-tools-link');
      let textToolsLoaded = false;

      async function showTextTools(skipPush){
        if(!textToolsLoaded){
          const resp = await fetch('/text_tools');
          const html = await resp.text();
          const root = document.querySelector('.retrorecon-root') || document.body;
          root.insertAdjacentHTML('beforeend', html);
          const script = document.createElement('script');
          script.src = '/static/text_tools.js';
          document.body.appendChild(script);
          textToolsLoaded = true;
        }
        document.getElementById('text-tools-overlay').classList.remove('hidden');
        if(window.loadTextNotes) window.loadTextNotes();
        document.body.style.overflow = 'hidden';
        if(!skipPush){
          history.pushState({tool:'text'}, '', '/tools/text_tools');
        }
      }

      function hideTextTools(){
        const ov = document.getElementById('text-tools-overlay');
        if(ov) ov.classList.add('hidden');
        document.body.style.overflow = '';
      }

      if (textToolsLink) {
        textToolsLink.addEventListener('click', async (e) => {
          e.preventDefault();
          showTextTools();
        });
      }

      window.addEventListener('popstate', () => {
        if(location.pathname === '/tools/text_tools'){
          showTextTools(true);
        } else {
          hideTextTools();
        }
      });

      if(location.pathname === '/tools/text_tools' || openTool === 'text'){
        showTextTools(true);
      }

      const jwtToolsLink = document.getElementById('jwt-tools-link');
      let jwtToolsLoaded = false;

      async function showJwtTools(skipPush){
        if (!jwtToolsLoaded) {
          const resp = await fetch('/jwt_tools');
          const html = await resp.text();
          const root = document.querySelector('.retrorecon-root') || document.body;
          root.insertAdjacentHTML('beforeend', html);
          const script = document.createElement('script');
          script.src = '/static/jwt_tools.js';
          document.body.appendChild(script);
          jwtToolsLoaded = true;
        }
        document.getElementById('jwt-tools-overlay').classList.remove('hidden');
        if(!skipPush){
          history.pushState({tool:'jwt'}, '', '/tools/jwt');
        }
      }

      function hideJwtTools(){
        const ov = document.getElementById('jwt-tools-overlay');
        if(ov) ov.classList.add('hidden');
      }

      if (jwtToolsLink) {
        jwtToolsLink.addEventListener('click', async (e) => {
          e.preventDefault();
          showJwtTools();
        });
      }

      window.addEventListener('popstate', () => {
        if(location.pathname === '/tools/jwt'){
          showJwtTools(true);
        } else {
          hideJwtTools();
        }
      });

      if(location.pathname === '/tools/jwt' || openTool === 'jwt'){
        showJwtTools(true);
      }

      const screenshotLink = document.getElementById('screenshot-link');
      let screenshotLoaded = false;

      async function showScreenshot(skipPush){
        if(!screenshotLoaded){
          const resp = await fetch('/screenshotter');
          const html = await resp.text();
          const root = document.querySelector('.retrorecon-root') || document.body;
          root.insertAdjacentHTML('beforeend', html);
          const script = document.createElement('script');
          script.src = '/static/screenshotter.js';
          document.body.appendChild(script);
          screenshotLoaded = true;
        }
        document.getElementById('screenshot-overlay').classList.remove('hidden');
        if(!skipPush){
          history.pushState({tool:'screenshot'}, '', '/tools/screenshotter');
        }
      }

      function hideScreenshot(){
        const ov = document.getElementById('screenshot-overlay');
        if(ov) ov.classList.add('hidden');
      }

      if(screenshotLink){
        screenshotLink.addEventListener('click', async (e) => {
          e.preventDefault();
          showScreenshot();
        });
      }

      const httpolaroidLink = document.getElementById('httpolaroid-link');
      let httpolaroidLoaded = false;

      async function showHttpolaroid(skipPush){
        if(!httpolaroidLoaded){
          const resp = await fetch('/httpolaroid');
          const html = await resp.text();
          const root = document.querySelector('.retrorecon-root') || document.body;
          root.insertAdjacentHTML('beforeend', html);
          const script = document.createElement('script');
          script.src = '/static/httpolaroid.js';
          document.body.appendChild(script);
          httpolaroidLoaded = true;
        }
        document.getElementById('httpolaroid-overlay').classList.remove('hidden');
        if(!skipPush){
          history.pushState({tool:'httpolaroid'}, '', '/tools/httpolaroid');
        }
      }

      function hideHttpolaroid(){
        const ov = document.getElementById('httpolaroid-overlay');
        if(ov) ov.classList.add('hidden');
      }

      if(httpolaroidLink){
        httpolaroidLink.addEventListener('click', async (e) => {
          e.preventDefault();
          showHttpolaroid();
        });
      }

      const layerpeekLink = document.getElementById('layerpeek-link');
      const layerpeekBLink = document.getElementById('layerpeek-b-link');
      let layerpeekLoaded = false;

      async function showLayerpeek(skipPush){
        if(!layerpeekLoaded){
          const resp = await fetch('/layerpeek');
          const html = await resp.text();
          const root = document.querySelector('.retrorecon-root') || document.body;
          root.insertAdjacentHTML('beforeend', html);
          const script = document.createElement('script');
          script.src = '/static/layerpeek.js';
          document.body.appendChild(script);
          layerpeekLoaded = true;
        }
        document.getElementById('layerslayer-overlay').classList.remove('hidden');
        if(!skipPush){
          history.pushState({tool:'layerpeek'}, '', '/tools/layerpeek');
        }
      }

      function hideLayerpeek(){
        const ov = document.getElementById('layerslayer-overlay');
        if(ov) ov.classList.add('hidden');
      }

      if(layerpeekLink){
        layerpeekLink.addEventListener('click', async (e) => {
          e.preventDefault();
          showLayerpeek();
        });
      }

      async function showLayerpeekB(skipPush){
        await showLayerpeek(true);
        if(!skipPush){
          history.pushState({tool:'layerpeek-b'}, '', '/tools/layerpeek-b');
        }
      }

      if(layerpeekBLink){
        layerpeekBLink.addEventListener('click', async (e) => {
          e.preventDefault();
          showLayerpeekB();
        });
      }

      const subLink = document.getElementById('subdomonster-link');
      let subLoaded = false;

      async function showSubdomonster(skipPush){
        if(!subLoaded){
          const resp = await fetch('/subdomonster');
          const html = await resp.text();
          const root = document.querySelector('.retrorecon-root') || document.body;
          root.insertAdjacentHTML('beforeend', html);
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = '/static/subdomonster.js';
            script.onload = resolve;
            script.onerror = reject;
            document.body.appendChild(script);
          });
          subLoaded = true;
        }
        const ov = document.getElementById('subdomonster-overlay');
        ov.classList.remove('hidden');
        if(window.startSubdomonsterStatus){
          window.startSubdomonsterStatus();
        }
        if(!skipPush){
          history.pushState({tool:'subdomonster'}, '', '/tools/subdomonster');
        }
      }

      function hideSubdomonster(){
        const ov = document.getElementById('subdomonster-overlay');
        if(ov){
          ov.classList.add('hidden');
          if(window.stopSubdomonsterStatus){
            window.stopSubdomonsterStatus();
          }
        }
      }

      if(subLink){
        subLink.addEventListener('click', async (e) => {
          e.preventDefault();
          closeMenus();
          showSubdomonster();
        });
      }

      window.addEventListener('popstate', () => {
        if(location.pathname === '/tools/subdomonster'){
          showSubdomonster(true);
        } else {
          hideSubdomonster();
        }
      });

      if(location.pathname === '/tools/subdomonster' || openTool === 'subdomonster'){
        showSubdomonster(true);
      }

      window.addEventListener('popstate', () => {
        if(location.pathname === '/tools/httpolaroid'){
          showHttpolaroid(true);
        } else {
          hideHttpolaroid();
        }
      });

      if(location.pathname === '/tools/httpolaroid' || openTool === 'httpolaroid'){
        showHttpolaroid(true);
      }

      window.addEventListener('popstate', () => {
        if(location.pathname === '/tools/layerpeek'){
          showLayerpeek(true);
        } else {
          hideLayerpeek();
        }
      });

      window.addEventListener('popstate', () => {
        if(location.pathname === '/tools/layerpeek-b'){
          showLayerpeekB(true);
        } else {
          hideLayerpeek();
        }
      });

      if(location.pathname === '/tools/layerpeek' || openTool === 'layerpeek'){
        showLayerpeek(true);
      }

      if(location.pathname === '/tools/layerpeek-b' || openTool === 'layerpeek-b'){
        showLayerpeekB(true);
      }

      window.addEventListener('popstate', () => {
        if(location.pathname === '/tools/screenshotter'){
          showScreenshot(true);
        } else {
          hideScreenshot();
        }
      });

      if(location.pathname === '/tools/screenshotter' || openTool === 'screenshot'){
        showScreenshot(true);
      }

      const demoLink = document.getElementById('demo-link');
      let demoLoaded = false;

      async function showDemo(skipPush){
        if(!demoLoaded){
          const resp = await fetch('/demo');
          const html = await resp.text();
          const root = document.querySelector('.retrorecon-root') || document.body;
          root.insertAdjacentHTML('beforeend', html);
          const script = document.createElement('script');
          script.src = '/static/demo.js';
          document.body.appendChild(script);
          demoLoaded = true;
        }
        document.getElementById('demo-overlay').classList.remove('hidden');
        if(!skipPush){
          history.pushState({tool:'demo'}, '', '/tools/demo');
        }
      }

      function hideDemo(){
        const ov = document.getElementById('demo-overlay');
        if(ov) ov.classList.add('hidden');
      }

      if(demoLink){
        demoLink.addEventListener('click', async (e) => {
          e.preventDefault();
          showDemo();
        });
      }

      window.addEventListener('popstate', () => {
        if(location.pathname === '/tools/demo'){
          showDemo(true);
        } else {
          hideDemo();
        }
      });

      if(location.pathname === '/tools/demo' || openTool === 'demo'){
        showDemo(true);
      }

      const registryLink = document.getElementById('oci-explorer-link');
      let registryLoaded = false;

      async function showRegistryViewer(skipPush){
        if(!registryLoaded){
          const resp = await fetch('/oci_explorer');
          const html = await resp.text();
          const root = document.querySelector('.retrorecon-root') || document.body;
          root.insertAdjacentHTML('beforeend', html);
          const script = document.createElement('script');
          script.src = '/static/oci_explorer.js';
          document.body.appendChild(script);
          registryLoaded = true;
        }
        document.getElementById('registry-explorer-overlay').classList.remove('hidden');
        if(!skipPush){
          history.pushState({tool:'registry'}, '', '/tools/oci_explorer');
        }
      }

      function hideRegistryViewer(){
        const ov = document.getElementById('registry-explorer-overlay');
        if(ov) ov.classList.add('hidden');
      }

      if(registryLink){
        registryLink.addEventListener('click', async (e) => {
          e.preventDefault();
          showRegistryViewer();
        });
      }

      window.addEventListener('popstate', () => {
        if(location.pathname === '/tools/oci_explorer'){
          showRegistryViewer(true);
        } else {
          hideRegistryViewer();
        }
      });

      if(location.pathname === '/tools/oci_explorer' || openTool === 'registry'){
        showRegistryViewer(true);
      }

      const ociLink = document.getElementById('oci-explorer-link');
      if(ociLink){
        ociLink.addEventListener('click', async (e) => {
          e.preventDefault();
          showRegistryViewer();
        });
      }

      window.addEventListener('popstate', () => {
        if(location.pathname === '/tools/oci_explorer'){
          showRegistryViewer(true);
        } else {
          hideRegistryViewer();
        }
      });

      const helpReadmeLink = document.getElementById('help-readme-link');
      let helpReadmeLoaded = false;
      async function showHelpReadme(skipPush){
        if(!helpReadmeLoaded){
          const resp = await fetch('/help/readme');
          const html = await resp.text();
          const root = document.querySelector('.retrorecon-root') || document.body;
          root.insertAdjacentHTML('beforeend', html);
          const script = document.createElement('script');
          script.src = '/static/help_readme.js';
          document.body.appendChild(script);
          helpReadmeLoaded = true;
        }
        document.getElementById('help-readme-overlay').classList.remove('hidden');
        if(!skipPush){
          history.pushState({tool:'readme'}, '', '/tools/readme');
        }
      }
      function hideHelpReadme(){
        const ov = document.getElementById('help-readme-overlay');
        if(ov) ov.classList.add('hidden');
      }
      if(helpReadmeLink){
        helpReadmeLink.addEventListener('click', async (e) => {
          e.preventDefault();
          showHelpReadme();
        });
      }

      const helpAboutLink = document.getElementById('help-about-link');
      let helpAboutLoaded = false;
      async function showHelpAbout(skipPush){
        if(!helpAboutLoaded){
          const resp = await fetch('/help/about');
          const html = await resp.text();
          const root = document.querySelector('.retrorecon-root') || document.body;
          root.insertAdjacentHTML('beforeend', html);
          const script = document.createElement('script');
          script.src = '/static/help_about.js';
          document.body.appendChild(script);
          helpAboutLoaded = true;
        }
        document.getElementById('help-about-overlay').classList.remove('hidden');
        if(!skipPush){
          history.pushState({tool:'about'}, '', '/tools/about');
        }
      }
      function hideHelpAbout(){
        const ov = document.getElementById('help-about-overlay');
        if(ov) ov.classList.add('hidden');
      }
      if(helpAboutLink){
        helpAboutLink.addEventListener('click', async (e) => {
          e.preventDefault();
          showHelpAbout();
        });
      }

      window.addEventListener('popstate', () => {
        if(location.pathname === '/tools/readme'){
          showHelpReadme(true);
        } else if(location.pathname === '/tools/about'){
          showHelpAbout(true);
        } else {
          hideHelpReadme();
          hideHelpAbout();
        }
      });

      if(location.pathname === '/tools/readme' || openTool === 'readme'){
        showHelpReadme(true);
      }
      if(location.pathname === '/tools/about' || openTool === 'about'){
        showHelpAbout(true);
      }

    const themeSelect = document.getElementById('theme-select');
    const themeForm = document.getElementById('set-theme-form');
    const themeInput = document.getElementById('set-theme-input');
    if (themeSelect && themeForm && themeInput) {
      themeSelect.addEventListener('change', () => {
        themeInput.value = themeSelect.value;
        themeForm.submit();
      });
    }


    function toggleBackground(cb){
      if(cb.checked){
        document.body.classList.remove('bg-hidden');
      } else {
        document.body.classList.add('bg-hidden');
      }
    }

    const bgSelect = document.getElementById('background-select');
    const bgForm = document.getElementById('set-bg-form');
    const bgInput = document.getElementById('set-bg-input');
    if (bgSelect && bgForm && bgInput) {
      bgSelect.addEventListener('change', () => {
        const bg = bgSelect.value;
        bgInput.value = bg;
        bgForm.submit();
        document.body.style.background = "url('/static/img/" + bg + "') no-repeat center center fixed";
        document.body.style.backgroundSize = 'cover';
      });
    }

    const opacityRange = document.getElementById('opacity-range');
    let currentOpacity = null;
    function updateOpacity(val){
      const op = val / 100;
      document.documentElement.style.setProperty('--panel-opacity', op);
    }
    function persistOpacity(val){
      const op = val / 100;
      if(op === currentOpacity) return;
      currentOpacity = op;
      fetch('/set_panel_opacity', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'opacity=' + op
      });
    }
    if(opacityRange){
      opacityRange.addEventListener('input', function(){
        updateOpacity(this.value);
      });
      opacityRange.addEventListener('change', function(){
        persistOpacity(this.value);
      });
      updateOpacity(opacityRange.value);
      currentOpacity = parseFloat(opacityRange.value)/100;
    }

    const fontInput = document.getElementById('font-size-input');
    if(fontInput){
      fontInput.addEventListener('change', function(){
        const themeSel = document.getElementById('theme-select');
        const theme = themeSel ? themeSel.value : '';
        fetch('/set_font_size', {
          method: 'POST',
          headers: {'Content-Type': 'application/x-www-form-urlencoded'},
          body: new URLSearchParams({size: this.value, theme: theme})
        });
      });
    }

    const perPageInput = document.getElementById('items-count-input');
    if(perPageInput){
      document.querySelectorAll('#results-per-page-select').forEach(sel => {
        sel.addEventListener('change', function(){
          perPageInput.value = this.value;
          document.getElementById('set-items-form').submit();
        });
      });
    }

    // Sorting functionality
    document.querySelectorAll('.url-table th.sortable').forEach(th => {
      th.addEventListener('click', (ev) => {
        if(ev.target.closest('.col-resizer')) return;
        const sort = th.getAttribute('data-sort');
        const params = new URLSearchParams(window.location.search);
        const currentSort = params.get('sort');
        let dir = params.get('dir') || 'asc';
        if(currentSort === sort){
          dir = dir === 'asc' ? 'desc' : 'asc';
        } else {
          dir = 'asc';
        }
        params.set('sort', sort);
        params.set('dir', dir);
        window.location = '/?' + params.toString();
      });
    });

    // Column resizing
    function makeResizable(table, key){
      table.style.tableLayout = 'fixed';
      const ths = table.querySelectorAll('th');
      const cols = table.querySelectorAll('col');
      let widths = {};
      try{ widths = JSON.parse(localStorage.getItem(key) || '{}'); }catch{}
      ths.forEach((th, idx) => {
        const id = idx;
        if(widths[id]){
          th.style.width = widths[id];
          if(cols[id]) cols[id].style.width = widths[id];
        }
        const initial = th.style.width || th.offsetWidth + 'px';
        th.style.width = initial;
        if(cols[id]) cols[id].style.width = initial;
        if(th.classList.contains('no-resize')) return;
        const res = document.createElement('div');
        res.className = 'col-resizer';
        th.appendChild(res);
        let startX = 0;
        let startWidth = 0;
        res.addEventListener('mousedown', e => {
          startX = e.pageX;
          startWidth = th.offsetWidth;
          document.addEventListener('mousemove', onMove);
          document.addEventListener('mouseup', stop);
          e.preventDefault();
        });
        function onMove(e){
          const w = Math.max(30, startWidth + (e.pageX - startX));
          th.style.width = w + 'px';
          if(cols[id]) cols[id].style.width = w + 'px';
          widths[id] = w + 'px';
        }
        function stop(){
          document.removeEventListener('mousemove', onMove);
          document.removeEventListener('mouseup', stop);
          localStorage.setItem(key, JSON.stringify(widths));
        }
      });
    }

    const urlTable = document.querySelector('.url-table');
  if(urlTable) makeResizable(urlTable, 'url-col-widths');
  </script>
</div>
<script src="{{ url_for('static', filename='index_page.js') }}"></script>
</body>
</html>
