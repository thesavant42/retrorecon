<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>retrorecon - {{ db_name }} - {{ total_count }} results</title>
  <link rel="stylesheet" href="/static/wabax.css" />
  {% if current_theme %}
  <link rel="stylesheet" href="{{ url_for('static', filename='themes/' + current_theme) }}" />
  {% endif %}
</head>
<body>
  {% macro render_pagination(page, total_pages, q, tag, total_count) %}
  <div class="pagination" style="margin-top:1em;">
    <span class="page-info">Displaying page {{ page }} of {{ total_pages }}</span>
    {% if page > 1 %}
      <a href="?page=1&q={{ q }}&tag={{ tag }}">&#171;&#171;</a>
      <a href="?page={{ page - 1 }}&q={{ q }}&tag={{ tag }}">&#171;</a>
    {% endif %}
    {% set start = page - 2 if page - 2 > 2 else 1 %}
    {% set end = page + 2 if page + 2 < total_pages - 1 else total_pages %}
    {% if start > 1 %}
      <a href="?page=1&q={{ q }}&tag={{ tag }}">1</a>
      {% if start > 2 %}<span>...</span>{% endif %}
    {% endif %}
    {% for p in range(start, end + 1) %}
      {% if p == page %}
        <strong>{{ p }}</strong>
      {% else %}
        <a href="?page={{ p }}&q={{ q }}&tag={{ tag }}">{{ p }}</a>
      {% endif %}
    {% endfor %}
    {% if end < total_pages %}
      {% if end < total_pages - 1 %}<span>...</span>{% endif %}
      <a href="?page={{ total_pages }}&q={{ q }}&tag={{ tag }}">{{ total_pages }}</a>
    {% endif %}
    {% if page < total_pages %}
      <a href="?page={{ page + 1 }}&q={{ q }}&tag={{ tag }}">&#187;</a>
      <a href="?page={{ total_pages }}&q={{ q }}&tag={{ tag }}">&#187;&#187;</a>
    {% endif %}
    <form style="display:inline; margin-left:1em;" onsubmit="return gotoPage(this);">
      <input type="hidden" name="q" value="{{ q }}" />
      <input type="hidden" name="tag" value="{{ tag }}" />
      <input type="text" name="page" size="2" placeholder="Page" />
      <button type="submit">Go</button>
    </form>
    <span class="total-count">Total: {{ total_count }}</span>
  </div>
  {% endmacro %}
  <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">

  <!-- Table A : Header -->
  <table id="layout-a" style="width:100%;">
    <tr>
      <td style="text-align:left;">
        <div class="dropdown menu-dropdown">
          <button class="dropbtn" id="main-dropdown-btn">Menu ‚ñº</button>
          <div class="dropdown-content" id="main-dropdown-content">
            <div class="import-controls">
              <div style="font-weight:bold;">Import Options</div>
              <form class="import-row" method="POST" action="/fetch_cdx">
                <label>‚è≥ Import from CDX API:
                  <input type="text" name="domain" placeholder="example.com" required />
                </label>
                <button type="submit">Fetch</button>
              </form>
              <form class="import-row" method="POST" action="/import_json" enctype="multipart/form-data" id="import-form">
                <label>üìÑ Import from JSON:
                  <input type="file" name="json_file" required />
                </label>
                <button type="submit">Import</button>
              </form>
              <form class="import-row" method="POST" action="/load_db" enctype="multipart/form-data">
                <label>üìÇ SQLite DB:
                  <input type="file" name="db_file" required />
                </label>
                <button type="submit">Import</button>
              </form>
              <div style="margin-top:8px;">
                <form method="GET" action="/save_db" id="save-db-form" style="display:inline;">
                  <button type="submit">üíæ Save As</button>
                </form>
                <form method="POST" action="/new_db" style="display:inline; margin-left:4px;">
                  <button type="submit">üÜï New DB</button>
                </form>
              </div>
            </div>
            <hr style="margin:8px 0;">
            <div>
              <form method="POST" action="/tools/webpack-zip">
                <label>üîç Explode .js.map URL:
                  <input type="text" name="map_url" placeholder="https://example.com/file.js.map" required style="width:160px;" />
                </label>
                <button type="submit">Explode &amp; Download ZIP</button>
              </form>
            </div>
            <hr style="margin:8px 0;">
              <div style="font-weight:bold;">Bulk Actions</div>
              <div class="bulk-controls">
                <button type="submit" form="bulk-form" name="action" value="add_tag" class="bulk-action-btn">‚ûïüè∑Ô∏è Add Tag All Selected</button>
                <button type="submit" form="bulk-form" name="action" value="remove_tag" class="bulk-action-btn">‚ûñüè∑Ô∏è Remove Tag Selected</button>
                <button type="submit" form="bulk-form" name="action" value="delete" class="bulk-action-btn">‚úÇüóëÔ∏è Delete Selected</button>
                <input type="text" name="tag" id="bulk-tag-input" form="bulk-form" placeholder="Tag" />
                <div class="checkbox-row">
                  <label class="select-all-label" style="margin-left:1em;">
                    <input type="checkbox" id="select-all-page" onclick="toggleSelectAllPage(this)">
                    Select all visible
                  </label>
                  <label class="select-all-label">
                    <input type="checkbox" id="select-all-matching" onclick="toggleSelectAllMatching(this)">
                    Select all matching
                  </label>
                </div>
              </div>
              <hr style="margin:8px 0;">
              <div style="font-weight:bold;">Themes</div>
              <form method="POST" action="/set_theme" class="theme-row" style="margin-bottom:4px;">
                <select name="theme">
                  {% for t in themes %}
                  <option value="{{ t }}" {% if t == current_theme %}selected{% endif %}>{{ t.replace('theme-','').replace('.css','') }}</option>
                  {% endfor %}
                </select>
                <button type="submit">Apply</button>
              </form>
              <label style="display:block;">
                <input type="checkbox" id="bg-toggle" checked onchange="toggleBackground(this)">
                Show background image
              </label>
          </div>
        </div>
      </td>
      <td style="text-align:left;">
        <h1>retrorecon <span style="font-size:0.7em; color:#666;">v1.0.0</span></h1>
      </td>
    </tr>
  </table>

  <!-- Table B : Search bar and buttons -->
  <div class="search-bar">
    <form method="GET" action="/" id="search-form">
      <table style="width:100%;">
        <tr>
          <td style="text-align:center;">
            <input type="text" name="q" placeholder="Search..." value="{{ q }}" id="searchbox" style="width:95%;" />
          </td>
        </tr>
      </table>
      <div class="search-actions">
        <div id="search-history" class="search-history"></div>
        <div class="search-buttons">
          <button type="button" id="save-tag-btn">Save Tag</button>
          <button type="submit">Search</button>
          <button type="button" onclick="document.getElementById('searchbox').value=''; document.getElementById('search-form').submit();">Clear</button>
        </div>
      </div>
    </form>
  </div>

  <!-- Table C : Pagination and saved tags -->
  <table id="layout-c" style="width:100%; margin-top:1em;">
    <tr>
      <td style="text-align:left;">
        {{ render_pagination(page, total_pages, q, tag, total_count) }}
      </td>
    </tr>
  </table>

  <!-- Table D : Results -->
  <table id="layout-d" style="width:100%; margin-top:1em;">
    <tr>
      <td>
        <div class="results-grid">
          <div id="import-status-block" style="display:none;">
            <strong>Import status:</strong>
            <span id="import-status-text"></span>
            <div id="import-progress-bar-container">
              <div id="import-progress-bar"></div>
            </div>
            <div id="import-progress-numbers" style="margin-top:0.5em;">
              <span id="import-progress-numbers-span"></span>
            </div>
          </div>

          {% if urls %}
          <form method="POST" action="/bulk_action" id="bulk-form">
            <input type="hidden" name="q" value="{{ q }}" />
            <input type="hidden" name="tag" value="{{ tag }}" />
            <input type="hidden" name="select_all_matching" id="select-all-matching-input" value="false" />

            <!-- Data table -->
            <table class="url-table">
              <thead>
                <tr>
                  <th style="width:2em;">
                    <input type="checkbox" id="select-all-rows" onchange="toggleSelectAllRows(this)" onclick="event.stopPropagation()" />
                  </th>
                  <th>URL</th>
                  <th>Timestamp</th>
                  <th>HTTP</th>
                  <th>MIME</th>
                </tr>
              </thead>
              <tbody>
                {% for url in urls %}
                <tr class="url-row-main" onclick="window.open('{{ url.url }}', '_blank');" style="cursor:pointer;">
                  <td>
                    <input type="checkbox" class="row-checkbox" name="selected_ids" value="{{ url.id }}" onclick="event.stopPropagation()" />
                  </td>
                  <td>{{ url.url }}</td>
                  <td>{{ url.timestamp or '-' }}</td>
                  <td class="status {% if url.status_code %}status-{{ (url.status_code|string)[:1] }}{% endif %}">{{ url.status_code if url.status_code else '-' }}</td>
                  <td>{{ url.mime_type or '-' }}</td>
                </tr>
                <tr class="url-row-buttons">
                  <td></td>
                  <td colspan="4">
                    <div class="url-tools-row" style="white-space: nowrap;">
                      <button class="explode-btn" type="button" title="Wayback" onclick="window.open('https://web.archive.org/web/*/{{ url.url }}','_blank')">‚è≥</button>
                      <button class="explode-btn" type="button" title="Shodan" onclick="window.open('https://www.shodan.io/search?query={{ url.url|urlencode }}','_blank')">ü§ñ</button>
                      <button class="explode-btn" type="button" title="VirusTotal" onclick="window.open('https://www.virustotal.com/gui/search/{{ url.url|urlencode }}','_blank')">ü¶†</button>
                      <button class="explode-btn" type="button" title="GitHub" onclick="window.open('https://github.com/search?q={{ url.url|urlencode }}','_blank')">üêô</button>
                      <button class="explode-btn" type="button" title="Google" onclick="window.open('https://www.google.com/search?q=site:{{ url.url|urlencode }}','_blank')">üîç</button>
                      <button class="explode-btn" type="button" title="crt.sh" onclick="window.open('https://crt.sh/?q={{ url.url|urlencode }}','_blank')">üîè</button>
                      {% if ".js.map" in url.url %}
                      <form method="POST" action="/tools/webpack-zip" style="display:inline;">
                        <input type="hidden" name="map_url" value="{{ url.url }}" />
                        <button type="submit" class="explode-btn" title="Explode .js.map">üí• Explode!</button>
                      </form>
                      {% endif %}
                      <button class="explode-btn copy-btn" type="button" data-url="{{ url.url }}" title="Copy">üìã</button>
                      <form method="POST" action="/bulk_action" style="display:inline;margin-right:0.3em;">
                        <input type="hidden" name="action" value="delete" />
                        <input type="hidden" name="selected_ids" value="{{ url.id }}" />
                        <input type="hidden" name="q" value="{{ q }}" />
                        <input type="hidden" name="tag" value="{{ tag }}" />
                        <button type="submit" class="delete-btn" title="Delete">üóëÔ∏è</button>
                      </form>
                      {% for tag in (url.tags or '').split(',') if tag %}
                      <span class="tag-pill">{{ tag }}
                        <form method="POST" action="/bulk_action" style="display:inline;">
                          <input type="hidden" name="action" value="remove_tag" />
                          <input type="hidden" name="tag" value="{{ tag }}" />
                          <input type="hidden" name="selected_ids" value="{{ url.id }}" />
                          <button type="submit" title="Remove tag">&times;</button>
                        </form>
                      </span>
                      {% endfor %}
                      <form method="POST" action="/bulk_action" style="display:inline; margin-left:0.5em;">
                        <input type="hidden" name="action" value="add_tag" />
                        <input type="hidden" name="selected_ids" value="{{ url.id }}" />
                        <input type="text" name="tag" placeholder="Tag" size="8" required/>
                        <button type="submit" title="Add tag">+</button>
                      </form>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </form>
          {% else %}
            <div style="margin:2em; color:#888; text-align:center;">No URLs found for this query.</div>
          {% endif %}
        </div>
      </td>
    </tr>
    <tr>
      <td>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:1em;">
          <div>{{ render_pagination(page, total_pages, q, tag, total_count) }}</div>
          <div class="footer">
            <a href="https://github.com/thesavant42/retrorecon" target="_blank" style="text-decoration:none; color:#888;">
              &copy; 2025 retrorecon - Archive Explorer
            </a>
          </div>
        </div>
      </td>
    </tr>
  </table>

  <script>

    document.getElementById('main-dropdown-btn').addEventListener('click', function(e) {
      e.preventDefault();
      this.parentElement.classList.toggle('show');
    });
    document.addEventListener('click', function(e) {
      var dropdown = document.querySelector('.dropdown');
      if (dropdown && !dropdown.contains(e.target)) {
        dropdown.classList.remove('show');
      }
    });

    function toggleSelectAllPage(cb) {
      document.querySelectorAll('.row-checkbox').forEach(c => c.checked = cb.checked);
      document.getElementById('select-all-matching').checked = false;
      document.getElementById('select-all-matching-input').value = "false";
    }

    function toggleSelectAllMatching(cb) {
      document.getElementById('select-all-matching-input').value = cb.checked ? "true" : "false";
      document.getElementById('select-all-page').checked = false;
      if (cb.checked) {
        document.querySelectorAll('.row-checkbox').forEach(c => c.checked = true);
      }
    }

    function toggleSelectAllRows(cb) {
      document.querySelectorAll('.row-checkbox').forEach(c => c.checked = cb.checked);
    }

    var bulkForm = document.getElementById('bulk-form');
    if (bulkForm) {
      bulkForm.addEventListener('submit', function(e){
        const action = e.submitter ? e.submitter.value : '';
        if (action === 'delete') {
          if (document.getElementById('select-all-matching-input').value !== 'true') {
            const checked = document.querySelectorAll('.row-checkbox:checked');
            if (checked.length === 0) {
              alert('Please select at least one entry to delete.');
              e.preventDefault();
            }
          }
        } else if (['add_tag','remove_tag'].includes(action)) {
          if (!document.getElementById('bulk-tag-input').value.trim()) {
            alert('Please enter a tag.');
            e.preventDefault();
          }
        }
      });
    }

    function gotoPage(f) {
      const p = f.page.value.trim();
      if(p) {
        const params = new URLSearchParams();
        if(f.q && f.q.value) params.set('q', f.q.value);
        if(f.tag && f.tag.value) params.set('tag', f.tag.value);
        params.set('page', p);
        window.location = '/?' + params.toString();
      }
      return false;
    }

    document.querySelectorAll('.copy-btn').forEach(b => {
      b.addEventListener('click', async () => {
        const url = b.getAttribute('data-url');
        try {
          await navigator.clipboard.writeText(url);
          b.textContent = 'Copied!';
          setTimeout(() => { b.textContent = 'üìã Copy'; }, 1000);
        } catch {
          const t = document.createElement('textarea');
          t.value = url;
          document.body.appendChild(t);
          t.select();
          document.execCommand('copy');
          document.body.removeChild(t);
          b.textContent = 'Copied!';
          setTimeout(() => { b.textContent = 'üìã Copy'; }, 1000);
        }
      });
    });

    function pollImport() {
      fetch('/import_progress')
        .then(r => r.json())
        .then(data => {
          if (data.status && data.status !== 'idle') {
            document.getElementById('import-status-block').style.display = 'block';
            document.getElementById('import-status-text').textContent = data.detail || data.status;
            if (data.total) {
              const pct = Math.floor(data.progress / data.total * 100);
              document.getElementById('import-progress-bar').style.width = pct + '%';
              document.getElementById('import-progress-numbers-span').textContent = data.progress + '/' + data.total;
            }
            if (['done', 'failed'].includes(data.status)) {
              fetch('/import_progress?clear=1').then(() => {
                setTimeout(() => { window.location.reload(); }, 1000);
              });
              return;
            }
          }
          setTimeout(pollImport, 2000);
        })
        .catch(() => setTimeout(pollImport, 5000));
    }
    pollImport();

    function quickSearch(term){
      document.getElementById('searchbox').value = term;
      document.getElementById('search-form').submit();
    }

    function addHistoryButton(text){
      const historyDiv = document.getElementById('search-history');
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = text;
      btn.addEventListener('click', () => quickSearch(text));
      historyDiv.appendChild(btn);
    }

    function loadHistory(){
      const defaults = ['.js.map','.php','.env','.zip','.rar','.svg','.docx'];
      let saved = [];
      try { saved = JSON.parse(localStorage.getItem('searchHistory') || '[]'); } catch(e){}
      const all = Array.from(new Set(defaults.concat(saved)));
      all.forEach(addHistoryButton);
    }

    function saveTag(){
      const val = document.getElementById('searchbox').value.trim();
      if(!val) return;
      addHistoryButton(val);
      let saved = [];
      try { saved = JSON.parse(localStorage.getItem('searchHistory') || '[]'); } catch(e){}
      if(!saved.includes(val)){
        saved.push(val);
        localStorage.setItem('searchHistory', JSON.stringify(saved));
      }
    }

    document.getElementById('save-tag-btn').addEventListener('click', saveTag);
    loadHistory();

    const saveForm = document.getElementById('save-db-form');
    if (saveForm) {
      saveForm.addEventListener('submit', function(e) {
        if (!/name=/.test(this.action)) {
          e.preventDefault();
          const nm = prompt('Enter database name:', 'wabax');
          if (nm) {
            const enc = encodeURIComponent(nm.trim());
            window.location = '/save_db?name=' + enc;
          }
        }
      });
    }

    // Apply solid background and alignments on the URL results table
    document.querySelectorAll('.url-table tr').forEach(tr => {
      tr.style.backgroundColor = '#ffffff';
    });
    document.querySelectorAll('.url-table tbody tr').forEach(tr => {
      const cells = tr.querySelectorAll('td');
      if (cells.length >= 5) {
        cells[0].style.textAlign = 'center';
        cells[2].style.textAlign = 'center';
        cells[3].style.textAlign = 'center';
        cells[4].style.textAlign = 'center';
        cells[1].style.textAlign = 'left';
        cells[1].style.fontWeight = 'bold';
      }
    });

    function toggleBackground(cb){
      if(cb.checked){
        document.body.classList.remove('bg-hidden');
      } else {
        document.body.classList.add('bg-hidden');
      }
    }
  </script>
</body>
</html>
