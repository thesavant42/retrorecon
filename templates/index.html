<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WABAX - Wayback Archive eXplorer v1.0.0</title>
  <link rel="stylesheet" href="/static/wabax.css" />
</head>
<body>
  <h1>🔎⏳📁 WABAX: Wayback Archive eXplorer <span style="font-size:0.7em; color:#666;">v1.0.0</span> 📁⏳🔎</h1>

  <div id="import-status-block">
    <strong>Import status:</strong>
    <span id="import-status-text"></span>
    <div id="import-progress-bar-container">
      <div id="import-progress-bar"></div>
    </div>
    <div id="import-progress-numbers">
      <span id="import-progress-numbers-span"></span>
    </div>
  </div>

  <div class="controls">
    <div class="search-bar">
      <form method="GET" action="/">
        <input type="text" name="q" placeholder="Search..." value="{{ q }}" id="searchbox" />
        <button type="submit">Search</button>
        <button type="button" onclick="document.getElementById('searchbox').value=''; this.form.submit();">Clear</button>
      </form>
      <div id="quick-searches" style="margin-top:0.5em;">
        <button type="button" onclick="quickSearch('.js.map')">.js.map</button>
        <button type="button" onclick="quickSearch('.php')">.php</button>
        <button type="button" onclick="quickSearch('.env')">.env</button>
      </div>
    </div>
    <div class="dropdown" style="position: relative;">
      <button class="dropbtn" id="main-dropdown-btn">Menu ▼</button>
      <div class="dropdown-content" id="main-dropdown-content">
        <div>
          <form method="POST" action="/fetch_cdx" style="margin-bottom: 8px;">
            <label>🌐 Domain:
              <input type="text" name="domain" placeholder="example.com" required style="width:120px;"/>
            </label>
            <button type="submit">Fetch</button>
          </form>
          <form method="POST" action="/import_json" enctype="multipart/form-data" id="import-form">
            <label>📄 NDJSON:
              <input type="file" name="json_file" required />
            </label>
            <button type="submit">Import</button>
          </form>
        </div>
        <hr style="margin:8px 0;">
        <div>
          <form method="POST" action="/tools/webpack-zip">
            <label>🔍 Explode .js.map URL:
              <input type="text" name="map_url" placeholder="https://example.com/file.js.map" required style="width:160px;" />
            </label>
            <button type="submit">Explode &amp; Download ZIP</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  {% if urls %}
  <form method="POST" action="/bulk_action" id="bulk-form">
    <div class="bulk-controls">
      <select name="action">
        <option value="add_tag" selected>Add Tag</option>
        <option value="remove_tag">Remove Tag</option>
        <option value="delete">Delete</option>
      </select>
      <input type="text" name="tag" placeholder="Tag">
      <button type="submit">Apply</button>
      <label class="select-all-label">
        <input type="checkbox" id="select-all-page" onclick="toggleSelectAllPage(this)"> Select all visible
      </label>
      <label class="select-all-label">
        <input type="checkbox" id="select-all-matching" onclick="toggleSelectAllMatching(this)"> Select all matching
        <input type="hidden" name="select_all_matching" value="false">
      </label>
    </div>
    <div class="pagination">
      {% if page > 1 %}
        <a href="?page=1&q={{ q }}&tag={{ tag }}">⏮ First</a>
        <a href="?page={{ page - 1 }}&q={{ q }}&tag={{ tag }}">◀ Prev</a>
      {% endif %}
      {% set start = page - 3 if page - 3 >= 1 else 1 %}
      {% set end = page + 3 if page + 3 <= total_pages else total_pages %}
      {% for p in range(start, end + 1) %}
        {% if p == page %}
          <strong>{{ p }}</strong>
        {% else %}
          <a href="?page={{ p }}&q={{ q }}&tag={{ tag }}">{{ p }}</a>
        {% endif %}
      {% endfor %}
      {% if page < total_pages %}
        <a href="?page={{ page + 1 }}&q={{ q }}&tag={{ tag }}">Next ▶</a>
        <a href="?page={{ total_pages }}&q={{ q }}&tag={{ tag }}">Last ⏭</a>
      {% endif %}
      <form style="display:inline; margin-left:1em;" onsubmit="return gotoPage(this);">
        <input type="hidden" name="q" value="{{ q }}">
        <input type="hidden" name="tag" value="{{ tag }}">
        <input type="text" name="page" size="2" placeholder="Page">
        <button type="submit">Go</button>
      </form>
      <span style="margin-left:1em; color:#888;">Total: {{ total_count }}</span>
    </div>
    <table class="url-table">
      <thead>
        <tr>
          <th style="width:2em;"></th>
          <th>URL</th>
        </tr>
      </thead>
      <tbody>
        {% for url in urls %}
        <tr class="url-row-main" onclick="window.open('{{ url.url }}', '_blank');" style="cursor:pointer;">
          <td>
            <input type="checkbox" class="row-checkbox" name="selected_ids" value="{{ url.id }}" onclick="event.stopPropagation();">
          </td>
          <td>
            {{ url.url }}
          </td>
        </tr>
        <tr class="url-row-buttons">
          <td></td>
          <td>
            <div class="url-tools-row">
              <form method="POST" action="/add_tag" style="display:inline;" onsubmit="return addTagSubmit(this, {{ url.id }});">
                <input type="hidden" name="entry_id" value="{{ url.id }}">
                <input type="text" name="new_tag" class="tag-input" placeholder="Add tag">
                <button type="submit">➕</button>
              </form>
              {% for tag in (url.tags or '').split(',') if tag %}
                <span class="tag-pill">{{ tag }}
                  <form method="POST" action="/bulk_action" style="display:inline;">
                    <input type="hidden" name="action" value="remove_tag">
                    <input type="hidden" name="tag" value="{{ tag }}">
                    <input type="hidden" name="selected_ids" value="{{ url.id }}">
                    <button type="submit" title="Remove tag">&times;</button>
                  </form>
                </span>
              {% endfor %}
              <a href="https://web.archive.org/web/*/{{ url.url }}" target="_blank" class="btn-wayback" title="Wayback">🕰️</a>
              <a href="https://www.shodan.io/search?query={{ url.url | urlencode }}" target="_blank" class="shodan-btn" title="Shodan">🤖</a>
              <a href="https://www.virustotal.com/gui/search/{{ url.url | urlencode }}" target="_blank" class="vt-btn" title="VirusTotal">🦠</a>
              <a href="https://github.com/search?q={{ url.url | urlencode }}" target="_blank" class="github-btn" title="GitHub">🐙</a>
              <a href="https://www.google.com/search?q=site:{{ url.url | urlencode }}" target="_blank" class="google-btn" title="Google">🔍</a>
              <a href="https://crt.sh/?q={{ url.url | urlencode }}" target="_blank" class="crtsh-btn" title="crt.sh">📜</a>
              {% if ".js.map" in url.url %}
              <form method="POST" action="/tools/webpack-zip" style="display:inline;">
                <input type="hidden" name="map_url" value="{{ url.url }}">
                <button type="submit" class="explode-btn" title="Explode this .js.map">💥 Explode!</button>
              </form>
              {% endif %}
              <button class="copy-btn" type="button" data-url="{{ url.url }}">📋 Copy</button>
              <form method="POST" action="/bulk_action" style="display:inline;">
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="selected_ids" value="{{ url.id }}">
                <button class="delete-btn" type="submit" title="Delete">🗑️</button>
              </form>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="pagination">
      {% if page > 1 %}
        <a href="?page=1&q={{ q }}&tag={{ tag }}">⏮ First</a>
        <a href="?page={{ page - 1 }}&q={{ q }}&tag={{ tag }}">◀ Prev</a>
      {% endif %}
      {% set start = page - 3 if page - 3 >= 1 else 1 %}
      {% set end = page + 3 if page + 3 <= total_pages else total_pages %}
      {% for p in range(start, end + 1) %}
        {% if p == page %}
          <strong>{{ p }}</strong>
        {% else %}
          <a href="?page={{ p }}&q={{ q }}&tag={{ tag }}">{{ p }}</a>
        {% endif %}
      {% endfor %}
      {% if page < total_pages %}
        <a href="?page={{ page + 1 }}&q={{ q }}&tag={{ tag }}">Next ▶</a>
        <a href="?page={{ total_pages }}&q={{ q }}&tag={{ tag }}">Last ⏭</a>
      {% endif %}
      <form style="display:inline; margin-left:1em;" onsubmit="return gotoPage(this);">
        <input type="hidden" name="q" value="{{ q }}">
        <input type="hidden" name="tag" value="{{ tag }}">
        <input type="text" name="page" size="2" placeholder="Page">
        <button type="submit">Go</button>
      </form>
      <span style="margin-left:1em; color:#888;">Total: {{ total_count }}</span>
    </div>
  </form>
  {% else %}
    <p style="margin:2em auto; text-align:center; color:#666;">No results found.</p>
  {% endif %}

  <div class="footer">
    &copy; 2025 WABAX - Wayback Archive eXplorer
  </div>

  <script>
    function quickSearch(term) {
      var box = document.getElementById('searchbox');
      box.value = term;
      box.form.submit();
    }

    document.getElementById("main-dropdown-btn").addEventListener("click", function(e) {
      e.preventDefault();
      var dropdown = this.parentElement;
      dropdown.classList.toggle("show");
    });
    document.addEventListener("click", function(event) {
      var dropdown = document.querySelector(".dropdown");
      if (dropdown && !dropdown.contains(event.target)) {
        dropdown.classList.remove('show');
      }
    });

    function toggleSelectAllPage(box) {
      document.querySelectorAll('.row-checkbox').forEach(function(cb){
        cb.checked = box.checked;
      });
      if(!box.checked) {
        document.getElementById('select-all-matching').checked = false;
        document.querySelector('input[name="select_all_matching"]').value = 'false';
      }
    }

    function toggleSelectAllMatching(checkbox) {
      document.querySelector('input[name="select_all_matching"]').value = checkbox.checked ? "true" : "false";
      if(checkbox.checked){
        document.getElementById('select-all-page').checked = false;
      }
    }

    function gotoPage(form) {
      var page = form.page.value;
      if(page) {
        var params = [];
        if(form.q && form.q.value) params.push('q='+encodeURIComponent(form.q.value));
        if(form.tag && form.tag.value) params.push('tag='+encodeURIComponent(form.tag.value));
        params.push('page='+encodeURIComponent(page));
        window.location = '/?'+params.join('&');
      }
      return false;
    }

    // Progress bar poller
    let importProgressInterval = null;
    function updateImportProgressBar(stopAfterDone = false) {
      fetch('/import_progress').then(res => res.json()).then(data => {
        const block = document.getElementById('import-status-block');
        const bar = document.getElementById('import-progress-bar');
        const barContainer = document.getElementById('import-progress-bar-container');
        const numbers = document.getElementById('import-progress-numbers');
        const numbersSpan = document.getElementById('import-progress-numbers-span');
        const statusText = document.getElementById('import-status-text');

        bar.style.background = '#cfcf22';

        if (['in_progress', 'starting', 'pending'].includes(data.status)) {
          block.style.display = '';
          barContainer.style.display = '';
          numbers.style.display = '';
          let pct = 0;
          if (data.total > 0) pct = Math.floor(100 * data.progress / data.total);
          bar.style.width = pct + "%";
          numbersSpan.textContent = `${data.progress}/${data.total}`;
          if (data.status == 'pending') statusText.textContent = "⏳ Pending...";
          else if (data.status == 'starting') statusText.textContent = "⏳ Starting...";
          else statusText.textContent = "⏳ In Progress...";
        } else if (data.status === 'done') {
          block.style.display = '';
          barContainer.style.display = '';
          bar.style.width = '100%';
          numbers.style.display = '';
          numbersSpan.textContent = `${data.progress}/${data.total}`;
          statusText.textContent = data.detail ? `✅ ${data.detail}` : "✅ Done!";
          // Stop polling after done, hide after short delay
          if (importProgressInterval) {
            clearInterval(importProgressInterval);
            importProgressInterval = null;
          }
          setTimeout(() => {
            block.style.display = 'none';
          }, 4000);
        } else if (data.status === 'failed') {
          block.style.display = '';
          barContainer.style.display = '';
          bar.style.width = '100%';
          numbers.style.display = '';
          statusText.textContent = "❌ Failed: " + (data.detail || "");
          bar.style.background = '#f44336';
          // Stop polling on failure
          if (importProgressInterval) {
            clearInterval(importProgressInterval);
            importProgressInterval = null;
          }
        } else {
          block.style.display = 'none';
          barContainer.style.display = 'none';
          numbers.style.display = 'none';
          // Stop polling if idle
          if (importProgressInterval) {
            clearInterval(importProgressInterval);
            importProgressInterval = null;
          }
        }
      });
    }
    window.addEventListener('DOMContentLoaded', function() {
      updateImportProgressBar();
      if (!importProgressInterval) {
        importProgressInterval = setInterval(updateImportProgressBar, 1000);
      }
    });

    // Button actions for shodan, crt.sh, etc
    document.addEventListener("DOMContentLoaded", function () {
      document.querySelectorAll(".copy-btn").forEach((btn) => {
        btn.addEventListener("click", async function (e) {
          e.preventDefault();
          const urlToCopy = btn.getAttribute("data-url");
          if (!urlToCopy) return;
          try {
            await navigator.clipboard.writeText(urlToCopy);
            btn.textContent = "Copied!";
            setTimeout(() => (btn.textContent = "📋 Copy"), 1000);
          } catch (err) {
            const temp = document.createElement("textarea");
            temp.value = urlToCopy;
            temp.style.position = "fixed";
            temp.style.top = "-1000px";
            document.body.appendChild(temp);
            temp.focus();
            temp.select();
            document.execCommand("copy");
            document.body.removeChild(temp);
            btn.textContent = "Copied!";
            setTimeout(() => (btn.textContent = "📋 Copy"), 1000);
          }
        });
      });
    });

    // Tag add - prevent empty submission
    function addTagSubmit(form, id) {
      const input = form.querySelector('input[name="new_tag"]');
      if (!input.value.trim()) {
        input.focus();
        return false;
      }
      return true;
    }
  </script>
</body>
</html>